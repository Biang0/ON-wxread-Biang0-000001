name: WeRead AutoBot

on:
  schedule:
    # UTCæ—¶é—´ä¸åŒ—äº¬æ—¶é—´å¯¹ç…§ï¼ˆå‘¨ä¸€åˆ°å‘¨å…­ï¼‰
    - cron: '0 21 * * 1-6'    # åŒ—äº¬å‘¨äºŒåˆ°å‘¨ä¸€ 05:00 (UTCå‘¨ä¸€21:00)
    - cron: '50 3 * * 1-6'    # åŒ—äº¬å‘¨äºŒåˆ°å‘¨ä¸€ 11:50 (UTC 03:50)
    - cron: '0 14 * * 1-6'    # åŒ—äº¬å‘¨äºŒåˆ°å‘¨ä¸€ 22:00 (UTC 14:00)
    # å‘¨æ—¥å…¨å¤©è¦†ç›–ï¼ˆUTCå‘¨å…­16:00-å‘¨æ—¥15:59ï¼‰
    - cron: '0 16-23 * * 6'   # åŒ—äº¬å‘¨æ—¥00:00-07:59
    - cron: '0 0-15 * * 0'    # åŒ—äº¬å‘¨æ—¥08:00-23:59

  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto=è‡ªåŠ¨ç”Ÿæˆ/manual=æ‰‹åŠ¨è¾“å…¥)'
        required: false
        default: 'auto'
      duration:
        description: 'æ‰‹åŠ¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰30-240'
        required: false
        type: number

jobs:
  deploy:
    runs-on: ubuntu-24.04
    env:
      TZ: Asia/Shanghai  # å®¹å™¨å†…æ—¥å¿—æ˜¾ç¤ºåŒ—äº¬æ—¶é—´
      WEEKLY_TARGET: 1488  # æ¯å‘¨ç›®æ ‡åˆ†é’Ÿæ•°ï¼ˆ24.8h=1488minï¼‰

    steps:
    # ========================
    # é˜¶æ®µ1ï¼šæ—¶é—´ç­–ç•¥å¼•æ“
    # ========================
    - name: â° æ—¶é—´ç­–ç•¥å¼•æ“
      id: time_engine
      run: |
        # è·å–UTCæ˜ŸæœŸå‡ ï¼ˆ0=å‘¨æ—¥ï¼‰
        DAY=$(date -u +%w)
        HOUR=$(date -u +%H)
        echo "::group::ğŸ“… æ—¶é—´ç­–ç•¥åˆ†æ"
        echo "UTCæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S')"
        echo "åŒ—äº¬æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
        echo "è§¦å‘æ–¹å¼: ${{ github.event&#95;name }}"
        echo "è§¦å‘è§„åˆ™: ${{ github.event.schedule || 'æ‰‹åŠ¨è§¦å‘' }}"
        
        # æ‰‹åŠ¨æ¨¡å¼å¤„ç†
        if [[ "${{ github.event_name }}" == 'workflow_dispatch' ]]; then
          MODE="${{ inputs.mode }}"
          if [[ "$MODE" == "manual" ]]; then
            DURATION=${{ inputs.duration || 0 }}
            if (( DURATION < 30 || DURATION > 240 )); then
              echo "âš ï¸ æ‰‹åŠ¨æ—¶é•¿$DURATIONæ— æ•ˆï¼Œç”Ÿæˆå®‰å…¨å€¼"
              DURATION=$((60 + RANDOM % 121))  # 60-180åˆ†é’Ÿ
            fi
            READ_NUM=$(( DURATION &#42; 2 ))
            echo "æ‰‹åŠ¨æ¨¡å¼ | æ—¶é•¿: ${DURATION}åˆ†é’Ÿ"
          else
            READ_NUM=$(( 90 + RANDOM % 301 ))  # 45-150åˆ†é’Ÿ
            echo "è‡ªåŠ¨æ¨¡å¼ | éšæœºæ—¶é•¿: $((READ_NUM/2))åˆ†é’Ÿ"
          fi
        # å‘¨æ—¥ä»»åŠ¡
        elif [[ "$DAY" -eq 0 || "${{ github.event.schedule }}" =~ '0 16-23' || "${{ github.event.schedule }}" =~ '0 0-15' ]]; then
          if (( RANDOM % 1440 < 60 )); then  # æ¯å¤©éšæœºè§¦å‘ä¸€æ¬¡
            READ_NUM=$(( 60 + RANDOM % 181 ))  # 30-120åˆ†é’Ÿ
            echo "ğŸ² å‘¨æ—¥éšæœºä»»åŠ¡è§¦å‘ | æ—¶é•¿: $((READ_NUM/2))åˆ†é’Ÿ"
          else
            echo "â­ï¸ å‘¨æ—¥æœªå‘½ä¸­éšæœºæ—¶æ®µ"
            exit 0
          fi
        # å‘¨ä¸€åˆ°å‘¨å…­ä»»åŠ¡
        else
          case "${{ github.event.schedule }}" in
            '0 21 * * 1-6')  # æ—©é—´ä»»åŠ¡
              BASE=222  # 3.7å°æ—¶=222åˆ†é’Ÿ
              ;;
            '50 3 * * 1-6')  # åˆé—´ä»»åŠ¡
              BASE=222
              ;;
            '0 14 * * 1-6')  # æ™šé—´ä»»åŠ¡
              BASE=246  # 4.1å°æ—¶=246åˆ†é’Ÿ
              ;;
          esac
          READ_NUM=$(( BASE + RANDOM % 25 ))  # 3.7-4.2å°æ—¶
          echo "æ—¥å¸¸ä»»åŠ¡ | æ—¶æ®µ: ${BASE}åŸºå‡† | éšæœºå¢é‡: $((READ_NUM - BASE))åˆ†é’Ÿ"
        fi
        
        # ç”Ÿæˆå»¶è¿Ÿå‚æ•°
        DELAY=$(( RANDOM % 21 ))  # 0-20åˆ†é’Ÿ
        echo "::endgroup::"
        
        # è¾“å‡ºå‚æ•°
        echo "READ_NUM=$READ&#95;NUM" >> $GITHUB_OUTPUT
        echo "DELAY=$DELAY" >> $GITHUB_ENV
        echo "DAY_TYPE=$([[ $DAY -eq 0 ]] && echo 'weekend' || echo 'weekday')" >> $GITHUB_ENV

    # ========================
    # é˜¶æ®µ2ï¼šå»¶è¿Ÿæ‰§è¡Œ
    # ========================
    - name: â³ æ™ºèƒ½å»¶è¿Ÿ
      if: ${{ env.DELAY > 0 }}
      run: |
        echo "â±ï¸ éšæœºå»¶è¿Ÿ ${{ env.DELAY }} åˆ†é’Ÿï¼ˆè§„é¿æ•´ç‚¹é«˜å³°ï¼‰"
        sleep $(( ${{ env.DELAY }} * 60 ))

    # ========================
    # é˜¶æ®µ3ï¼šæ‰§è¡Œæ ¸å¿ƒä»»åŠ¡
    # ========================
    - name: ğŸš€ æ‰§è¡Œé˜…è¯»ä»»åŠ¡
      env:
        READ_NUM: ${{ steps.time_engine.outputs.READ_NUM }}
      run: |
        echo "::group::ğŸ“Š ä»»åŠ¡å‚æ•°æ‘˜è¦"
        echo "æ‰§è¡Œæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
        echo "å½“æ—¥ç±»å‹: ${{ env.DAY_TYPE }}"
        echo "é˜…è¯»æ¬¡æ•°: $READ&#95;NUM (ç­‰æ•ˆ$((READ_NUM/2))åˆ†é’Ÿ)"
        echo "ç´¯è®¡æ—¶é•¿: $((READ&#95;NUM/2 + ${{ env.DELAY }}))åˆ†é’Ÿ"
        echo "::endgroup::"
        
        # æ¨¡æ‹Ÿä»»åŠ¡æ‰§è¡Œï¼ˆæ›¿æ¢ä¸ºå®é™…è°ƒç”¨ï¼‰
        for ((i=1; i<=$READ&#95;NUM; i++)); do
          echo "ğŸ“– é˜…è¯»è¿›åº¦ [$i/$READ&#95;NUM] å½“å‰æ—¶é—´: $(date +'%H:%M:%S')"
          sleep 30
        done

    # ========================
    # é˜¶æ®µ4ï¼šå‘¨æŠ¥ç”Ÿæˆ
    # ========================
    - name: ğŸ“ˆ å‘¨æŠ¥ç”Ÿæˆ
      if: ${{ always() }}
      run: |
        echo "::warning::å‘¨æŠ¥åŠŸèƒ½å¼€å‘ä¸­ï¼Œé¢„è®¡2025Q2ä¸Šçº¿"
        # æ­¤å¤„å¯é›†æˆæ•°æ®åº“è®°å½•æ¯å‘¨æ€»æ—¶é•¿
