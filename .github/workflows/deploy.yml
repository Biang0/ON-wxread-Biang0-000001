name: wxread

on:
  schedule:
    # UTCæ—¶é—´æ¢ç®—ï¼ˆåŒ—äº¬æ—¶é—´=UTC+8ï¼‰
    - cron: '0 21 * * *'   # åŒ—äº¬5:00ï¼ˆ21+8=29â†’5:00ï¼‰
    - cron: '40 3 * * *'   # åŒ—äº¬11:40ï¼ˆ3+8=11ï¼‰
    - cron: '0 14 * * *'   # åŒ—äº¬22:00ï¼ˆ14+8=22ï¼‰
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    # ----------------- åˆå§‹åŒ–é˜¶æ®µ -----------------
    - name: ğŸŒ ç½‘ç»œé…ç½®
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
        echo "âœ… DNSé…ç½®å®Œæˆ | Google DNSç”Ÿæ•ˆ"

    - name: ğŸ“¦ ä»£ç ä»“åº“æ£€å‡º
      uses: actions/checkout@v4
      with:
        persist-credentials: false

    # ---------------- ç¯å¢ƒå‡†å¤‡ --------------------
    - name: ğŸ Pythonç¯å¢ƒåˆå§‹åŒ–
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: ğŸ“š ä¾èµ–å®‰è£…
      run: |
        pip install -r requirements.txt
        echo "ğŸ” éªŒè¯å®‰è£… | $(pip show requests | grep Version)"

    # ---------------- æ‰§è¡Œæ§åˆ¶ --------------------
    - name: ğŸ² éšæœºå»¶è¿Ÿ
      run: |
        DELAY=$(( RANDOM % 21 ))  # 0-20åˆ†é’Ÿéšæœºå»¶è¿Ÿ
        echo "â³ å»¶è¿Ÿè®¾ç½®ï¼š${DELAY}åˆ†é’Ÿ"
        sleep $(( DELAY * 60 ))
        echo "â° å®é™…å»¶è¿Ÿï¼š${DELAY}åˆ†é’Ÿ"

    - name: ğŸ•’ é˜…è¯»æ—¶é•¿ç”Ÿæˆ
      run: |
        case "${{ github.event.schedule }}" in
          '0 21 * * *')   # æ—©é—´ä»»åŠ¡
            # 45-65åˆ†é’Ÿ â†’ 90-130 READ_NUM
            NUM=$(( RANDOM % 41 + 90 ))  # 41=130-90+1
            echo "ğŸŒ… æ—©é—´ä»»åŠ¡ | èŒƒå›´ï¼š90-130ï¼ˆ45-65åˆ†é’Ÿï¼‰" ;;
          '40 3 * * *')   # åˆé—´ä»»åŠ¡
            NUM=$(( RANDOM % 61 + 120 ))  # 120-180ï¼ˆ60-90åˆ†é’Ÿï¼‰
            echo "ğŸŒ åˆé—´ä»»åŠ¡ | èŒƒå›´ï¼š120-180" ;;
          '0 14 * * *')   # æ™šé—´ä»»åŠ¡
            NUM=$(( RANDOM % 61 + 180 ))  # 180-240ï¼ˆ90-120åˆ†é’Ÿï¼‰
            echo "ğŸŒ™ æ™šé—´ä»»åŠ¡ | èŒƒå›´ï¼š180-240" ;;
          *)
            NUM=120  # å®‰å…¨é»˜è®¤å€¼
            echo "âš ï¸ æœªçŸ¥è§¦å‘ç±»å‹ | ä½¿ç”¨é»˜è®¤å€¼" ;;
        esac

        # å¼ºåˆ¶æ—©é—´èŒƒå›´é™åˆ¶
        if [[ "${{ github.event.schedule }}" == '0 21 * * *' ]]; then
          NUM=$(( NUM < 90 ? 90 : NUM ))  # ä¸‹é™ä¿æŠ¤
          NUM=$(( NUM > 130 ? 130 : NUM ))  # ä¸Šé™ä¿æŠ¤
        fi
        
        echo "ğŸ“Š ç”Ÿæˆæ•°å€¼ï¼šREAD_NUM=${NUM}ï¼ˆç­‰æ•ˆ $((NUM/2)) åˆ†é’Ÿï¼‰"
        echo "READ_NUM=$NUM" >> $GITHUB_ENV

    - name: ğŸš€ æ‰§è¡Œé˜…è¯»è„šæœ¬
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
      run: |
        python main.py
        echo "ğŸ”š è„šæœ¬é€€å‡ºç ï¼š$?"

    # ---------------- ç»“æœéªŒè¯ --------------------
    - name: ğŸ“ æ—©é—´ä»»åŠ¡éªŒè¯
      if: contains(github.event.schedule, '0 21 * * *')
      run: |
        if [ $READ_NUM -lt 90 ] || [ $READ_NUM -gt 130 ]; then
          echo "âŒ æ•°å€¼å¼‚å¸¸ | å®é™…å€¼ï¼š$READ_NUM"
          exit 1
        else
          echo "âœ… åˆè§„æ£€æŸ¥é€šè¿‡ | æœ‰æ•ˆèŒƒå›´ï¼š90-130"
        fi
