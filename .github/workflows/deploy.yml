name: wxread

on:
  schedule:
    - cron: '00 14 * * *'           # 晚间任务：22:00（每天）
    - cron: '0 21 * * 1-5'          # 早间任务：05:00（周一到周五）
    - cron: '40 3 * * 1-5'          # 午间任务：11:40（周一到周五）
    - cron: '0 9 * * sat,sun'       # 周末任务：17:00（周六/日）
    - cron: '0 0 * * sat,sun'       # 周随机任务：08:00（周末）
  workflow_dispatch:
    description: 手动触发微信阅读任务（默认不延迟）
    inputs:
      mode:
        description: '运行模式 (auto/manual)'
        required: false
        default: 'manual'   # 修改默认值为 manual，避免手动触发时有随机延迟

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    - name: 📥 检出仓库
      uses: actions/checkout@v4

    - name: 🐍 设置 Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 📦 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ⏱️ 随机延迟（仅限自动模式）
      if: github.event.inputs.mode == 'auto'
      run: |
        DELAY=$((RANDOM % 21))
        echo "⏳ 生成的随机延迟：${DELAY} 分钟"
        sleep $((DELAY * 60))
        echo "✅ 延迟执行完成"

    - name: 🚀 执行主程序
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
      run: |
        echo "=== 执行参数 ==="
        echo "READ_NUM: ${{ env.READ_NUM }}"
        python main.py || (echo "❌ 运行失败，推送通知..." && python -c "from push import push; push('❌ 微信阅读任务失败，请检查日志！', '${{ secrets.PUSH_METHOD }}')" && exit 1)