name: WeRead Automation

on:
  schedule:
    # ==============================================
    # æ—¥å¸¸ä»»åŠ¡ï¼ˆå‘¨ä¸€åˆ°å‘¨å…­ åŒ—äº¬æ—¶é—´ï¼‰
    # ==============================================
    - cron: '0 21 * * 1-6'    # UTC 21:00 â†’ åŒ—äº¬5:00ï¼ˆæ¬¡æ—¥ï¼‰
    - cron: '40 3 * * 1-6'    # UTC 3:40 â†’ åŒ—äº¬11:40
    - cron: '0 14 * * 1-6'    # UTC 14:00 â†’ åŒ—äº¬22:00

    # ==============================================
    # å‘¨æ—¥ä»»åŠ¡å…¥å£ï¼ˆUTCå‘¨å…­16ç‚¹ â†’ åŒ—äº¬å‘¨æ—¥0ç‚¹ï¼‰
    # ==============================================
    - cron: '0 16 * * 6'

  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ [auto:æ™ºèƒ½æ¨¡å¼ / manual:æ‰‹åŠ¨è°ƒè¯•]'
        required: false
        default: 'auto'

jobs:
  daily_task:
    name: æ—¥å¸¸é˜…è¯»ä»»åŠ¡ï¼ˆå‘¨ä¸€åˆ°å…­ï¼‰
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    # ------------------------------
    # åˆå§‹åŒ–ç¯å¢ƒ
    # ------------------------------
    - name: ğŸ”§ æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸŒ å®‰è£…æµè§ˆå™¨ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver

    - name: ğŸ“¦ å®‰è£…PythonåŒ…
      run: pip install selenium webdriver-manager

    # ------------------------------
    # æ—¶æ®µè¯†åˆ«æ¨¡å—
    # ------------------------------
    - name: ğŸ•’ è¯†åˆ«è§¦å‘æ—¶æ®µ
      id: time_period
      run: |
        case "${{ github.event.schedule }}" in
          *'0 21 * * '*)
            echo "PERIOD=morning" >> $GITHUB_ENV
            echo "ğŸ•– æ—¶æ®µï¼šæ—©é—´ï¼ˆåŒ—äº¬5:00ï¼‰" ;;
          *'40 3 * * '*)
            echo "PERIOD=noon" >> $GITHUB_ENV
            echo "ğŸ•¦ æ—¶æ®µï¼šåˆé—´ï¼ˆåŒ—äº¬11:40ï¼‰" ;;
          *'0 14 * * '*)
            echo "PERIOD=night" >> $GITHUB_ENV
            echo "ğŸ•™ æ—¶æ®µï¼šæ™šé—´ï¼ˆåŒ—äº¬22:00ï¼‰" ;;
        esac

    # ------------------------------
    # é˜…è¯»å‚æ•°ç”Ÿæˆå™¨ï¼ˆåˆ†é’Ÿåˆ¶ï¼‰
    # ------------------------------
    - name: ğŸ¯ ç”Ÿæˆé˜…è¯»å‚æ•°
      run: |
        case $PERIOD in
          morning)
            # æ—©é—´ï¼š45-75åˆ†é’Ÿ
            DURATION=$((45 + RANDOM % 31)) ;;
          noon)
            # åˆé—´ï¼š60-90åˆ†é’Ÿ
            DURATION=$((60 + RANDOM % 31)) ;;
          night)
            # æ™šé—´ï¼šåŠ¨æ€è¡¥å……å‰©ä½™æ—¶é•¿ï¼ˆæ€»é…é¢228åˆ†é’Ÿï¼‰
            REMAINING=$((228 - (75 + 90)))
            DURATION=$(( REMAINING > 30 ? REMAINING : 90 )) ;;
        esac

        echo "READ_DURATION=$DURATION" >> $GITHUB_ENV
        echo "ğŸ“ˆ ç”Ÿæˆå‚æ•°ï¼š$DURATION åˆ†é’Ÿ"

    # ------------------------------
    # æµè§ˆå™¨è‡ªåŠ¨åŒ–æ¨¡å—
    # ------------------------------
    - name: ğŸš€ æ‰§è¡Œé˜…è¯»è¡Œä¸º
      env:
        WEREAD_COOKIE: ${{ secrets.WEREAD_COOKIE }}
        READ_DURATION: ${{ env.READ_DURATION }}
      run: |
        # é˜²å¾¡æ€§æ£€æŸ¥
        if [ -z "$WEREAD_COOKIE" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ£€æµ‹åˆ°å¾®ä¿¡è¯»ä¹¦Cookie"
          exit 1
        fi

        # å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤ºå¹¶è¿è¡Œè‡ªåŠ¨åŒ–è„šæœ¬
        export DISPLAY=:0
        xvfb-run --auto-servernum python wechat_read_local.py

    # ------------------------------
    # æ—¥å¿—æ”¶é›†ï¼ˆä»…å¤±è´¥æ—¶ï¼‰
    # ------------------------------
    - name: ğŸ“¤ ä¸Šä¼ è°ƒè¯•ä¿¡æ¯
      if: ${{ failure() }}
      uses: actions/upload-artifact@v3
      with:
        name: error-info
        path: |
          *.log
          /tmp/chrome-session/

  sunday_task:
    name: å‘¨æ—¥å…¨éšæœºä»»åŠ¡
    runs-on: ubuntu-22.04
    environment: AutoRead
    needs: daily_task

    steps:
    - name: ğŸŒ é…ç½®æµè§ˆå™¨ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ² éšæœºæ—¶é•¿é˜…è¯»
      env:
        WEREAD_COOKIE: ${{ secrets.WEREAD_COOKIE }}
      run: |
        # ç”Ÿæˆ120-180åˆ†é’Ÿéšæœºæ—¶é•¿
        RANDOM_DURATION=$((120 + RANDOM % 61))
        echo "ğŸ² å‘¨æ—¥éšæœºæ—¶é•¿ï¼š$RANDOM_DURATION åˆ†é’Ÿ"
        
        export DISPLAY=:0
        xvfb-run --auto-servernum python wechat_read_local.py $RANDOM_DURATION
