name: WXRead-Final

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ä»»åŠ¡è°ƒåº¦
    - cron: '0 21 * * *'    # åŒ—äº¬5:00 (UTC 21:00)
      timezone: Asia/Shanghai
    - cron: '45 3 * * *'    # åŒ—äº¬11:45 (UTC 03:45)
      timezone: Asia/Shanghai
    - cron: '0 14 * * *'    # åŒ—äº¬22:00 (UTC 14:00)
      timezone: Asia/Shanghai
    - cron: '0 21 * * 0'    # å‘¨æ—¥åŒ—äº¬5:00 (UTC å‘¨å…­21:00)
      timezone: Asia/Shanghai

  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'

jobs:
  wxread:
    runs-on: ubuntu-22.04
    environment: Production
    timeout-minutes: 360  # 6å°æ—¶è¶…æ—¶

    steps:
    # ========== ç¯å¢ƒåˆå§‹åŒ– ==========
    - name: ğŸŒ ç½‘ç»œé…ç½®
      run: |
        sudo cp /etc/resolv.conf /etc/resolv.conf.backup
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf

    - name: ğŸ“¥ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    # ========== Pythonç¯å¢ƒ ==========
    - name: ğŸ è®¾ç½®Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“ ç”Ÿæˆä¾èµ–æ–‡ä»¶
      run: |
        cat << EOF > requirements.txt
        certifi==2024.8.30
        charset-normalizer==3.4.0
        idna==3.10
        requests==2.32.3
        urllib3==2.2.3
        EOF
        echo "âœ… ç”Ÿæˆçš„requirements.txtï¼š"
        cat requirements.txt

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        echo "å·²å®‰è£…ï¼š"
        pip list | grep -E 'certifi|charset|idna|requests|urllib3'

    # ========== ä»»åŠ¡æ§åˆ¶ ==========
    - name: â³ åˆå§‹å»¶è¿Ÿ
      run: |
        DELAY=$(python -c "import random; print(random.randint(0, 20))")
        echo "â±ï¸ éšæœºå»¶è¿Ÿ: ${DELAY}åˆ†é’Ÿ"
        sleep $((DELAY * 60))

    - name: ğŸ° å‘¨æ—¥éšæœºæ£€æŸ¥
      if: |
        github.event_name == 'schedule' &&
        contains(github.event.schedule, '0 21 * * 0')
      run: |
        CHECK=$(python -c "import random; print(random.randint(0, 6))")
        echo "ğŸ¯ å‘¨æ—¥éšæœºæ•°: ${CHECK}/6 (éœ€ä¸º0)"
        if [ $CHECK -ne 0 ]; then
          echo "â­ï¸ è·³è¿‡å‘¨æ—¥ä»»åŠ¡"
          exit 0
        fi

    # ========== æ ¸å¿ƒé€»è¾‘ ==========
    - name: âš™ï¸ ç”Ÿæˆé˜…è¯»å‚æ•°
      run: |
        # æ—¶é—´èŒƒå›´ 3.4-4.1å°æ—¶ â†’ 204-246åˆ†é’Ÿ
        TOTAL_MIN=$(python -c "import random; print(random.randint(204, 246))")
        
        # æ“ä½œé—´éš”é…ç½®
        BASE_INTERVAL=60    # åŸºç¡€æ“ä½œé—´éš”
        PAUSE_VARIATION=90 # éšæœºæ³¢åŠ¨èŒƒå›´
        
        # è®¡ç®—æ“ä½œæ¬¡æ•°
        MAX_OPS=$(( TOTAL_MIN * 60 / (BASE_INTERVAL + PAUSE_VARIATION) ))
        MIN_OPS=$(( TOTAL_MIN * 60 / BASE_INTERVAL ))
        FINAL_OPS=$(python -c "import random; print(random.randint($MAX_OPS, $MIN_OPS))")
        
        echo "ğŸ“Š æ€»æ—¶é•¿: ${TOTAL_MIN}åˆ†é’Ÿ"
        echo "ğŸ”„ æ“ä½œæ¬¡æ•°: ${FINAL_OPS}"
        echo "READ_OPS=${FINAL_OPS}" >> $GITHUB_ENV
        echo "PAUSE_VARIATION=${PAUSE_VARIATION}" >> $GITHUB_ENV

    - name: ğŸ“– æ‰§è¡Œé˜…è¯»
      env:
        API_KEY: ${{ secrets.WXREAD_API }}
      run: |
        set -euo pipefail
        MAX_RETRY=3
        
        for ((i=1; i<=$READ_OPS; i++)); do
          # ç”Ÿæˆéšæœºåœé¡¿
          PAUSE=$(python -c "import random; print(random.randint(0, $PAUSE_VARIATION))")
          TOTAL_SLEEP=$((BASE_INTERVAL + PAUSE))
          
          echo "ğŸ” æ“ä½œ ${i}/${READ_OPS} | åœç•™ ${TOTAL_SLEEP}s"
          
          # å¸¦é‡è¯•çš„è¯·æ±‚
          retry=0
          while [ $retry -lt $MAX_RETRY ]; do
            curl -sS -m 30 -H "Authorization: Bearer $API_KEY" &#92;
              "https://api.example.com/read?action=next" && break
            
            retry=$((retry+1))
            echo "âš ï¸ å¤±è´¥é‡è¯• ${retry}/${MAX_RETRY}"
            sleep 5
          done
          
          # æœ€ç»ˆå¤±è´¥å¤„ç†
          if [ $retry -eq $MAX_RETRY ]; then
            echo "âŒ è¿ç»­å¤±è´¥è¶…è¿‡${MAX_RETRY}æ¬¡"
            exit 1
          fi
          
          sleep $TOTAL_SLEEP
        done

    # ========== æ¸…ç†æŠ¥å‘Š ==========
    - name: ğŸ“ ç”ŸæˆæŠ¥å‘Š
      if: always()
      run: |
        echo "### æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡Œæ¨¡å¼**: ${{ inputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ€»æ“ä½œæ¬¡æ•°**: ${READ_OPS:-0}" >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€ç»ˆçŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ§¹ æ¢å¤DNS
      if: always()
      run: |
        sudo mv /etc/resolv.conf.backup /etc/resolv.conf || true
        echo "âœ… ç½‘ç»œé…ç½®å·²æ¢å¤"
