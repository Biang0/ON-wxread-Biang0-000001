name: WeRead Automation

on:
  schedule:
    # ==============================================
    # 周一到周六任务（北京时间）
    # ==============================================
    - cron: '0 21 * * 1-6'         # 周一至六 21:00 UTC → 北京5:00（次日）
    - cron: '40 3 * * 1-6'         # 周一至六 3:40 UTC → 北京11:40
    - cron: '0 14 * * 1-6'         # 周一至六 14:00 UTC → 北京22:00

    # ==============================================
    # 周日全天随机任务
    # ==============================================
    - cron: '0 16 * * 6'           # 周六16:00 UTC → 北京周日0:00（触发入口）

  workflow_dispatch:
    inputs:
      mode:
        description: '模式选择 (auto/manual)'
        required: false
        default: 'auto'

jobs:
  daily-task:
    name: 日常任务（周一到周六）
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    # ------------------------------
    # 基础配置
    # ------------------------------
    - name: 📥 检出代码库
      uses: actions/checkout@v4

    # ------------------------------
    # 时段识别模块
    # ------------------------------
    - name: 🕒 识别执行时段
      id: time_period
      run: |
        case "${{ github.event.schedule }}" in
          *'0 21 * * '*)
            echo "PERIOD=morning" >> $GITHUB_ENV
            echo "🌅 早间时段（北京5:00）" ;;
          *'40 3 * * '*)
            echo "PERIOD=noon" >> $GITHUB_ENV 
            echo "🌞 午间时段（北京11:40）" ;;
          *'0 14 * * '*)
            echo "PERIOD=night" >> $GITHUB_ENV
            echo "🌙 晚间时段（北京22:00）" ;;
        esac

    # ------------------------------
    # 动态参数生成
    # ------------------------------
    - name: 🎯 生成阅读参数
      run: |
        DAILY_QUOTA=456  # 3.8小时 × 120次/小时 = 456次
        
        case $PERIOD in
          morning)
            NUM=$((90 + RANDOM % 61))  # 45-75分钟 ;;
          noon)
            NUM=$((120 + RANDOM % 61)) # 60-90分钟 ;;
          night)
            # 计算剩余额度（假设早午各用最小值）
            USED=$((90 + 120))
            REMAINING=$((DAILY_QUOTA - USED))
            NUM=$(( REMAINING > 0 ? REMAINING : 120 )) ;;
        esac

        echo "📊 时段：$PERIOD | 生成值：$NUM (等效 $((NUM/2)) 分钟)"
        echo "READ_NUM=$NUM" >> $GITHUB_ENV

    # ------------------------------
    # 任务执行
    # ------------------------------
    - name: 🚀 执行阅读任务
      env:
        API_URL: ${{ secrets.READ_API }}
      run: |
        curl -sS "${API_URL}?num=$READ_NUM"

  sunday-task:
    name: 周日特别任务
    runs-on: ubuntu-22.04 
    environment: AutoRead
    needs: []  # 独立任务

    steps:
    # ------------------------------
    # 时区严格校验
    # ------------------------------
    - name: 🕐 验证北京时间
      id: tz_check
      run: |
        BEIJING_DAY=$(TZ='Asia/Shanghai' date +%u)
        if [ "$BEIJING_DAY" -ne 7 ]; then
          echo "❌ 校验失败：当前非北京时间周日"
          exit 1
        fi
        echo "✅ 北京时间周日验证通过"

    # ------------------------------
    # 全时段随机延迟
    # ------------------------------
    - name: ⏳ 生成随机延迟
      if: success()
      run: |
        # 使用加密级随机数（0-1439分钟）
        DELAY=$(od -An -N2 -tu2 /dev/urandom | awk '{print $1 % 1440}')
        H=$(( DELAY / 60 ))
        M=$(( DELAY % 60 ))
        
        echo "⏱️ 延迟：${DELAY}分钟（${H}小时${M}分）"
        sleep $(( DELAY * 60 ))

    # ------------------------------
    # 周日参数生成
    # ------------------------------
    - name: 🎲 生成阅读量
      run: |
        NUM=$((120 + RANDOM % 121))  # 60-120分钟
        echo "READ_NUM=$NUM" >> $GITHUB_ENV
        echo "🔔 周日阅读量：$NUM (等效 $((NUM/2)) 分钟)"

    # ------------------------------
    # 隐蔽执行
    # ------------------------------
    - name: 🚀 执行任务
      env:
        API_URL: ${{ secrets.READ_API }}
      run: |
        # 带伪装头部的请求
        curl -sS -H "User-Agent: Mozilla/5.0" "${API_URL}?num=$READ_NUM"
