name: wxread-final

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ -> UTCæ—¶é—´è½¬æ¢
    - cron: '0 21 * * *'    # åŒ—äº¬5:00 (UTC 21:00)
      timezone: Asia/Shanghai
    - cron: '45 3 * * *'    # åŒ—äº¬11:45 (UTC 03:45)
      timezone: Asia/Shanghai 
    - cron: '0 14 * * *'    # åŒ—äº¬22:00 (UTC 14:00)
      timezone: Asia/Shanghai
    - cron: '0 21 * * 0'    # å‘¨æ—¥åŒ—äº¬5:00 (UTC å‘¨å…­21:00)
      timezone: Asia/Shanghai
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    # ... [ä¿ç•™ç½‘ç»œã€Pythonç¯å¢ƒç­‰åŸºç¡€é…ç½®]

    - name: â±ï¸ å¯åŠ¨å»¶è¿Ÿ
      run: |
        # åˆå§‹éšæœºå»¶è¿Ÿï¼ˆ0-20åˆ†é’Ÿï¼‰
        DELAY=$(python -c "import random; print(random.randint(0, 20))")
        echo "ğŸ•’ åˆå§‹å»¶è¿Ÿ: ${DELAY}åˆ†é’Ÿ"
        sleep $((DELAY * 60))

    - name: ğŸ”¢ ç”Ÿæˆé˜…è¯»å‚æ•°
      run: |
        # æ—¶é—´èŒƒå›´ 3.4-4.1å°æ—¶ = 204-246åˆ†é’Ÿ
        # åŸºç¡€æ“ä½œæ¬¡æ•° = æ€»åˆ†é’Ÿæ•° * 60 / (æ“ä½œé—´éš” + åœé¡¿æ—¶é—´)
        
        # ç”ŸæˆåŸºç¡€å‚æ•°
        TOTAL_MIN=$(python -c "import random; print(random.randint(204, 246))")
        
        # ç”Ÿæˆéšæœºåœé¡¿å‚æ•°ï¼ˆ30-120ç§’ï¼‰
        PAUSE_MIN=30
        PAUSE_MAX=120
        PAUSE_RANGE=$(python -c "print($PAUSE_MAX - $PAUSE_MIN)")
        
        # è®¡ç®—ç­‰æ•ˆæ“ä½œæ¬¡æ•°
        BASE_OPS=$(( TOTAL_MIN * 60 / (60 + PAUSE_MIN) ))  # æœ€å°æ“ä½œæ¬¡æ•°
        MAX_OPS=$(( TOTAL_MIN * 60 / (60 + PAUSE_MAX) ))  # æœ€å¤§æ“ä½œæ¬¡æ•°
        FINAL_OPS=$(python -c "import random; print(random.randint($MAX_OPS, $BASE_OPS))")
        
        # è¾“å‡ºå‚æ•°
        echo "âœ… æ€»æ—¶é•¿: ${TOTAL_MIN}åˆ†é’Ÿ"
        echo "ğŸ”„ æ“ä½œæ¬¡æ•°: $FINAL_OPS (é—´éš” ${PAUSE_MIN}-${PAUSE_MAX}ç§’)"
        echo "READ_OPS=$FINAL_OPS" >> $GITHUB_ENV
        echo "PAUSE_RANGE=$PAUSE_RANGE" >> $GITHUB_ENV
        echo "PAUSE_BASE=$PAUSE_MIN" >> $GITHUB_ENV

    - name: ğŸ² å‘¨æ—¥éšæœºæ£€æŸ¥
      if: |
        github.event_name == 'schedule' &&
        contains(github.event.schedule, '0 21 * * 0')  # æ­£ç¡®å†™æ³•
      run: |
        CHECK=$(python -c "import random; print(random.randint(0, 6))")
        echo "å‘¨æ—¥éšæœºæ•°ï¼š$CHECK (éœ€è¦ç­‰äº0)"
        if [ $CHECK -ne 0 ]; then
          echo "â­ï¸ è·³è¿‡å‘¨æ—¥ä»»åŠ¡"
          exit 0
        fi


    - name: ğŸ“– æ‰§è¡Œé˜…è¯»ä»»åŠ¡
      env:
        WXREAD_TOKEN: ${{ secrets.WXREAD_CU }}
      run: |
        set -euo pipefail
        
        for ((i=1; i<=$READ_OPS; i++))
        do
          # ç”Ÿæˆéšæœºåœé¡¿æ—¶é—´
          PAUSE=$(python -c "import random; print(random.randint($PAUSE_BASE, $PAUSE_BASE+$PAUSE_RANGE))")
          
          echo "ğŸ” ç¬¬${i}æ¬¡æ“ä½œ | åœç•™${PAUSE}ç§’"
          
          # æ‰§è¡Œæ ¸å¿ƒé€»è¾‘ï¼ˆç¤ºä¾‹ï¼‰
          curl -sS -H "Authorization: Bearer $WXREAD_TOKEN" &#92;
            "https://api.example.com/read?action=next"
          
          # éšæœºåœé¡¿
          sleep $PAUSE
        done
        
        echo "âœ… é˜…è¯»ä»»åŠ¡å®Œæˆ | æ€»æ“ä½œ: $READ_OPS æ¬¡"

    # ... [ä¿ç•™æ—¥å¿—æŠ¥å‘Šç­‰ä¼˜åŒ–æ­¥éª¤]
