name: WXRead-Optimized

on:
  schedule:
    # 北京时间定时任务（UTC+8）
    - cron: '0 21 * * *'    # 早上5:00（UTC 21:00）
      timezone: Asia/Shanghai
    - cron: '45 3 * * *'    # 中午11:45（UTC 03:45）
      timezone: Asia/Shanghai
    - cron: '0 14 * * *'    # 晚上22:00（UTC 14:00）
      timezone: Asia/Shanghai
    - cron: '0 21 * * 0'    # 周日早上5:00（UTC周六21:00）
      timezone: Asia/Shanghai

  workflow_dispatch:
    inputs:
      mode:
        description: '运行模式 (auto/manual)'
        required: false
        default: 'auto'

jobs:
  wxread:
    runs-on: ubuntu-22.04
    environment: Production
    timeout-minutes: 360

    steps:
    # ========== 初始化阶段 ==========
    - name: 🌐 网络配置
      run: |
        sudo cp /etc/resolv.conf /etc/resolv.conf.backup
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf

    - name: 📥 检出仓库
      uses: actions/checkout@v4

    # ========== 安全验证阶段 ==========
    - name: 🔍 配置预检
      run: |
        echo "=== 安全验证 ==="
        echo "B_VALUES状态: ${{ secrets.B_VALUES != '' && '已配置' || '未配置' }}"
        echo "CURL配置状态: ${{ secrets.WXREAD_CURL_BASH != '' && '有效' || '无效' }}"
        
        if [ -z "${{ secrets.B_VALUES }}" ]; then
          echo "::error::必须配置B_VALUES环境变量"
          exit 1
        fi

    # ========== 环境配置阶段 ==========
    - name: 🐍 设置Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 📦 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install certifi==2024.8.30 requests==2.32.3 cryptography==42.0.8
        echo "✅ 依赖验证："
        pip list | grep -E 'certifi|requests|cryptography'

    # ========== 任务控制阶段 ==========
    - name: ⏳ 随机延迟
      run: |
        DELAY=$(python -c "import random; print(random.randint(0, 0))")
        echo "生成随机延迟：${DELAY}分钟"
        sleep $(($DELAY * 60))

    - name: 🎰 周日随机检查
      if: |
        github.event_name == 'schedule' &&
        contains(github.event.schedule, '0 21 * * 0')
      run: |
        CHECK=$(python -c "import random; print(random.randint(0, 6))")
        echo "周日触发检查：${CHECK}/6（需为0）"
        if [ $CHECK -ne 0 ]; then
          echo "⏭️ 跳过周日任务"
          exit 0
        fi

    # ========== 核心业务阶段 ==========
    - name: 🔧 运行前检查
      env:
        B_VALUES: ${{ secrets.B_VALUES }}
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
      run: |
        echo "=== 调试信息 ==="
        python -c "import os; print('B_VALUES样本:', os.getenv('B_VALUES','')[:6]+'...')"
        python -c "import os; print('CURL配置MD5:', os.getenv('WXREAD_CURL_BASH','')[:32])"

    - name: ⚙️ 生成阅读参数
      run: |
        # 时间范围3.4-4.1小时 → 204-246分钟
        TOTAL_MIN=$(python -c "import random; print(random.randint(204, 246))")
        echo "总阅读时长: ${TOTAL_MIN}分钟"
        
        # 计算操作次数范围
        BASE_INTERVAL=60
        PAUSE_MIN=30
        PAUSE_MAX=120
        echo "MAX_OPS=$(( TOTAL_MIN * 60 / (BASE_INTERVAL + PAUSE_MAX) ))" >> $GITHUB_ENV
        echo "MIN_OPS=$(( TOTAL_MIN * 60 / (BASE_INTERVAL + PAUSE_MIN) ))" >> $GITHUB_ENV

    - name: 🔢 动态生成READ_NUM
      run: |
        if [[ "${{ github.event.inputs.mode }}" == "manual" ]]; then
          NUM=$((RANDOM % 91 + 90))
          echo "🕹️ 手动模式 | 范围: 90-180"
        else
          case "${{ github.event.schedule }}" in
            '0 21 * * *') NUM=$((RANDOM % 61 + 90))   ;;  # 早间
            '45 3 * * *') NUM=$((RANDOM % 61 + 120))  ;;  # 午间
            '0 14 * * *') NUM=$((RANDOM % 61 + 120))  ;;  # 晚间
            '0 21 * * 0') NUM=$((RANDOM % 121 + 120)) ;;  # 周日
            *)           NUM=$((RANDOM % 61 + 120))  ;;  # 默认
          esac
        fi
        echo "✅ 最终READ_NUM: $NUM"
        echo "READ_NUM=$NUM" >> $GITHUB_ENV

    - name: 🚀 执行主程序
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
        B_VALUES: ${{ secrets.B_VALUES }}
      run: |
        echo "=== 执行参数 ==="
        echo "阅读次数: ${{ env.READ_NUM }}"
        echo "操作范围: ${{ env.MIN_OPS }}-${{ env.MAX_OPS }}次"
        python main.py
