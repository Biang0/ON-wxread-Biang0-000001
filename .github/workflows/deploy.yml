name: WeRead Automation

on:
  schedule:
    - cron: '0 21 * * 1-6'  # 北京时间5:00
    - cron: '40 3 * * 1-6'  # 北京时间11:40
    - cron: '0 14 * * 1-6'  # 北京时间22:00
    - cron: '0 16 * * 6'    # 北京时间周日0:00

  workflow_dispatch:
    inputs:
      duration:
        description: '阅读时长（分钟）'
        required: false
        default: '30'

jobs:
  automate_reading:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    environment: Production

    steps:
    - name: 🔧 检出代码
      uses: actions/checkout@v4

    - name: 🛠️ 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y &#92;
          chromium-browser &#92;
          chromium-chromedriver &#92;
          xvfb &#92;
          libgbm-dev

    - name: 🐍 配置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 📦 安装Python包
      run: |
        pip install selenium==4.15.2 webdriver-manager==4.0.1

    - name: 🍪 配置Cookie
      env:
        WEREAD_COOKIE: ${{ secrets.WEREAD_COOKIE }}
      run: |
        mkdir -p /tmp/chrome_profile
        echo '$WEREAD_COOKIE' > /tmp/cookies.json
        jq empty /tmp/cookies.json  # 验证JSON格式

    - name: ⏲️ 设置阅读时长
      run: |
        case "${{ github.event.schedule }}" in
          *'0 21'*) DURATION=$((40 + RANDOM % 20)) ;;  # 早间40-60分钟
          *'40 3'*) DURATION=$((60 + RANDOM % 30)) ;;  # 午间60-90分钟
          *'0 14'*) DURATION=$((50 + RANDOM % 25)) ;;  # 晚间50-75分钟
          *) DURATION=${{ inputs.duration || 120 }} ;; # 默认120分钟
        esac
        echo "READ_DURATION=$DURATION" >> $GITHUB_ENV

    - name: 📖 执行阅读任务
      env:
        DISPLAY: ':0'
        READ_DURATION: ${{ env.READ_DURATION }}
      run: |
        xvfb-run --auto-servernum &#92;
          python wechat_auto_read.py

    - name: 📤 上传调试信息
      if: ${{ failure() }}
      uses: actions/upload-artifact@v4
      with:
        name: debug-info-${{ github.run_id }}
        path: |
          automation.log
          /tmp/*.png
        retention-days: 2
