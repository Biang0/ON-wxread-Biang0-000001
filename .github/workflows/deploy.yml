name: wxread

on:
  schedule:
    - cron: '00 14 * * * # 晚间任务：22:00（每天）'
    - cron: '0 21 * * 1-5 # 早间任务：05:00（周一到周五）'
    - cron: '40 3 * * 1-5 # 午间任务：11:40（周一到周五）'
    - cron: '0 9 * * sat,sun # 周末任务：17:00（周六/日）'
    - cron: '0 0 * * sat,sun # 周随机任务：08:00（周末）'
  workflow_dispatch:
    description: 手动触发微信阅读任务（默认manual模式）
    inputs:
      mode:
        description: '运行模式 (auto/manual)'
        required: false
        default: 'manual'  # 默认手动模式


jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    - name: 🔧 设置DNS
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
        echo "✅ DNS配置完成"

    - name: 📥 检出仓库
      uses: actions/checkout@v4

    - name: 🐍 设置Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 📦 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install certifi==2024.8.30 charset-normalizer==3.4.0 idna==3.10.0 requests==2.32.3 urllib3==2.2.3
        echo "✅ 依赖安装验证：$(pip list | grep requests)"

    - name: ⏱️ 随机延迟
      if: github.event.inputs.mode == 'auto'
      run: |
        DELAY=$((RANDOM % 21))
        echo "生成的随机延迟：${DELAY}分钟"
        sleep $((DELAY * 60))
        echo "延迟执行完成"

    - name: 🎲 周随机检查
      if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * sat,sun'
      run: |
        CHECK=$((RANDOM % 7))
        echo "随机数：$CHECK (需要等于0)"
        if [ $CHECK -ne 0 ]; then
          echo "⏭️ 跳过周随机任务"
          exit 0
        fi
        echo "🎉 触发周随机任务"

    - name: 🔢 生成READ_NUM
      run: |
        echo "=== 触发事件分析 ==="
        echo "事件类型: ${{ github.event_name }}"
        echo "输入模式: ${{ github.event.inputs.mode }}"
        echo "定时规则: ${{ github.event.schedule }}"

        if [[ "${{ github.event.inputs.mode }}" == "manual" ]]; then
          NUM=$((RANDOM % 61 + 60))
          echo "🕹️ 手动模式 | 范围: 60-120 (30-60分钟)"
        else
          case "${{ github.event.schedule }}" in
            '0 21 * * 1-5') NUM=$((RANDOM % 31 + 130)) ;;
            '40 3 * * 1-5') NUM=$((RANDOM % 31 + 160)) ;;
            '00 14 * * *')  NUM=$((RANDOM % 31 + 190)) ;;
            '0 9 * * sat,sun') NUM=$((RANDOM % 31 + 190)) ;;
            '0 0 * * sat,sun') NUM=$((RANDOM % 61 + 120)) ;;
            *) NUM=$((RANDOM % 31 + 190)) ;;
          esac
        fi

        echo "✅ 最终READ_NUM: $NUM (等效 $((NUM / 2)) 分钟)"
        echo "READ_NUM=$NUM" >> $GITHUB_ENV

     - name: 🔢 生成random_b_value和书名
  run: |
    # 读取b_values
    B_VALUES=$(python -c "import ast; with open(\"config.py\", \"r\") as f: tree = ast.parse(f.read()); for node in ast.walk(tree): if isinstance(node, ast.Assign) and node.targets[0].id == \"b_values\": print(ast.literal_eval(node.value))")
    
    # 读取book_mapping（修复后的第106行）
    BOOK_MAPPING=$(python -c "import ast; with open(\"config.py\", \"r\") as f: tree = ast.parse(f.read()); for node in ast.walk(tree): if isinstance(node, ast.Assign) and node.targets[0].id == \"book_mapping\": print(ast.literal_eval(node.value))")
    
    # 随机选择b值
    B_ARRAY=(${B_VALUES// / })
    RANDOM_B_VALUE=${B_ARRAY[$((RANDOM % ${#B_ARRAY[@]}))]}
    
    # 获取书名
    BOOK_NAME=$(python -c "import ast; bm = ast.literal_eval('$BOOK_MAPPING'); print(bm.get('$RANDOM_B_VALUE', '未知书籍'))")
    
    # 输出到环境变量
    echo "RANDOM_B_VALUE=$RANDOM_B_VALUE" >> $GITHUB_ENV
    echo "BOOK_NAME=$BOOK_NAME" >> $GITHUB_ENV


    - name: 🚀 执行主程序 (b: ${{ env.RANDOM_B_VALUE }}, 书名: ${{ env.BOOK_NAME }})
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
      run: |
        echo "=== 执行参数 ==="
        echo "READ_NUM: ${{ env.READ_NUM }}"
        echo "RANDOM_B_VALUE: ${{ env.RANDOM_B_VALUE }}"
        echo "BOOK_NAME: ${{ env.BOOK_NAME }}"
        python main.py
