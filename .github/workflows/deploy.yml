name: WeRead AutoBot Pro

on:
  schedule:
    - cron: '0 21 * * 1-6'    # 北京5:00（周一至周六）
    - cron: '50 3 * * 1-6'    # 北京11:50
    - cron: '0 14 * * 1-6'    # 北京22:00
    - cron: '0 16-23 * * 6'   # 北京周日00:00-07:59
    - cron: '0 0-15 * * 0'    # 北京周日08:00-23:59

  workflow_dispatch:
    inputs:
      duration:
        description: '运行时长（分钟）30-240'
        required: false
        type: number

jobs:
  core_task:
    runs-on: ubuntu-24.04
    env:
      TZ: Asia/Shanghai
      WXPUSHER_SPT: ${{ secrets.WXPUSHER_SPT }}
      PUSH_METHOD: ${{ secrets.PUSH_METHOD }}
      WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}

    steps:
    # ========================
    # 阶段1：环境准备
    # ========================
    - name: 🛠 检出代码
      uses: actions/checkout@v4

    - name: 🐍 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 📦 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests cryptography

    # ========================
    # 阶段2：动态参数配置
    # ========================
    - name: ⚙️ 参数引擎
      id: config
      run: |
        # 手动模式处理
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ -n "${{ inputs.duration }}" ]]; then
            READ_NUM=$(( ${{ inputs.duration }} * 2 ))  # 转换为阅读次数
            echo "🛠️ 手动模式 | 次数: $READ_NUM"
          else
            echo "::error::手动触发需指定duration参数" && exit 1
          fi
        else
          # 自动模式逻辑
          day=$(date +%u)
          if [[ $day == 7 ]]; then  # 周日
            READ_NUM=$(( 180 + RANDOM % 121 ))  # 180-300次（90-150分钟）
          else
            READ_NUM=$(( 90 + RANDOM % 61 ))    # 90-150次（45-75分钟）
          fi
        fi

        # 参数校验
        if (( READ_NUM < 60 || READ_NUM > 300 )); then
          echo "::error::参数越界(60-300): $READ_NUM" && exit 1
        fi

        echo "READ_NUM=$READ_NUM" >> $GITHUB_ENV
        echo "::notice::生成阅读次数: $READ_NUM"

    # ========================
    # 阶段3：核心执行逻辑
    # ========================
    - name: 🤖 执行阅读任务
      env:
        READ_NUM: ${{ env.READ_NUM }}
        WXPUSHER_TOPIC_ID: ${{ secrets.WXPUSHER_TOPIC_ID }}
        WXPUSHER_UIDS: ${{ secrets.WXPUSHER_UIDS }}
      run: |
        echo "✅ 启动自动化脚本 | 计划次数: $READ_NUM"
        python -u main.py

    # ========================
    # 阶段4：智能通知系统
    # ========================
    - name: 📢 异常监控
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const status = process.env.STATUS || 'UNKNOWN'
          const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          const message = `❌ 任务异常终止&#92;n▸ 状态: ${status}&#92;n▸ 日志: ${runUrl}`
          
          // 企业微信机器人备用通知
          await fetch('https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              msgtype: "text",
              text: { content: message }
            })
          })
