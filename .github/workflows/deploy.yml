name: wxread

on:
  schedule:
    - cron: '0 21 * * *'   # åŒ—äº¬5:00
    - cron: '40 3 * * *'   # åŒ—äº¬11:40
    - cron: '0 14 * * *'   # åŒ—äº¬22:00
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    # ----------------- åˆå§‹åŒ–é˜¶æ®µ -----------------
    - name: ğŸ”§ DNSé…ç½®
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
        echo "âœ… DNSé…ç½®å®Œæˆ"

    - name: ğŸ“¥ ä»£ç æ£€å‡º
      uses: actions/checkout@v4
      with:
        path: main-repo  # æŒ‡å®šæ£€å‡ºç›®å½•

    # ---------------- ç¯å¢ƒå‡†å¤‡ --------------------
    - name: ğŸ Python 3.10ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'  # ä¿ç•™ç¼“å­˜æœºåˆ¶
        cache-dependency-path: ''  # æ˜¾å¼ç¦ç”¨requirements.txtæ£€æŸ¥

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        cd main-repo  # è¿›å…¥æ£€å‡ºç›®å½•
        python -m pip install --upgrade pip
        # ç›´æ¥æŒ‡å®šä¾èµ–ç‰ˆæœ¬ï¼ˆæ›¿ä»£requirements.txtï¼‰
        pip install requests==2.32.3 urllib3==2.2.3 certifi==2024.8.30 charset-normalizer==3.4.0
        echo "âœ… å·²å®‰è£…ä¾èµ–ï¼š$(pip list | grep requests)"

    # ---------------- æ‰§è¡Œæ§åˆ¶ --------------------
    - name: â³ éšæœºå»¶è¿Ÿ
      run: |
        DELAY=$((RANDOM % 21))
        echo "ç”Ÿæˆå»¶è¿Ÿï¼š${DELAY}åˆ†é’Ÿ"
        sleep $((DELAY * 60))
        echo "å»¶è¿Ÿæ‰§è¡Œå®Œæˆ"

    - name: ğŸ•’ ç”Ÿæˆé˜…è¯»å‚æ•°
      run: |
        case "${{ github.event.schedule }}" in
          '0 21 * * *')
            NUM=$((RANDOM % 41 + 90))  # 45-65åˆ†é’Ÿ
            echo "ğŸŒ… æ—©é—´ä»»åŠ¡ | èŒƒå›´ï¼š90-130" ;;
          '40 3 * * *')
            NUM=$((RANDOM % 61 + 120))  # 60-90åˆ†é’Ÿ
            echo "ğŸŒ åˆé—´ä»»åŠ¡ | èŒƒå›´ï¼š120-180" ;;
          '0 14 * * *')
            NUM=$((RANDOM % 61 + 180))  # 90-120åˆ†é’Ÿ
            echo "ğŸŒ™ æ™šé—´ä»»åŠ¡ | èŒƒå›´ï¼š180-240" ;;
          *)
            NUM=150
            echo "âš ï¸ ä½¿ç”¨é»˜è®¤å€¼" ;;
        esac
        echo "READ_NUM=$NUM" >> $GITHUB_ENV

    - name: ğŸš€ æ‰§è¡Œä¸»ç¨‹åº
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
      working-directory: main-repo  # æŒ‡å®šå·¥ä½œç›®å½•
      run: python main.py
