name: WXRead-Optimized

on:
  schedule:
    # åŒ—äº¬æ—¶é—´å®šæ—¶ä»»åŠ¡ï¼ˆUTC+8ï¼‰
    - cron: '0 21 * * *'    # æ—©ä¸Š5:00ï¼ˆUTC 21:00ï¼‰
      timezone: Asia/Shanghai
    - cron: '45 3 * * *'    # ä¸­åˆ11:45ï¼ˆUTC 03:45ï¼‰
      timezone: Asia/Shanghai
    - cron: '0 14 * * *'    # æ™šä¸Š22:00ï¼ˆUTC 14:00ï¼‰
      timezone: Asia/Shanghai
    - cron: '0 21 * * 0'    # å‘¨æ—¥æ—©ä¸Š5:00ï¼ˆUTCå‘¨å…­21:00ï¼‰
      timezone: Asia/Shanghai

  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'

jobs:
  wxread:
    runs-on: ubuntu-22.04
    environment: Production
    timeout-minutes: 360

    steps:
    # ========== ç¯å¢ƒåˆå§‹åŒ– ==========
    - name: ğŸŒ ç½‘ç»œé…ç½®
      run: |
        sudo cp /etc/resolv.conf /etc/resolv.conf.backup
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf

    - name: ğŸ“¥ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    # ========== Pythonç¯å¢ƒé…ç½® ==========
    - name: ğŸ è®¾ç½®Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install certifi==2024.8.30 charset-normalizer==3.4.0 idna==3.10 requests==2.32.3 urllib3==2.2.3
        echo "âœ… ä¾èµ–éªŒè¯ï¼š"
        pip list | grep -E 'certifi|requests|urllib3'

    # ========== ä»»åŠ¡æ§åˆ¶ ==========
    - name: â³ éšæœºå»¶è¿Ÿ
      run: |
        DELAY=$(python -c "import random; print(random.randint(0, 20))")
        echo "ç”Ÿæˆéšæœºå»¶è¿Ÿï¼š${DELAY}åˆ†é’Ÿ"
        sleep $(($DELAY * 60))

    - name: ğŸ° å‘¨æ—¥éšæœºæ£€æŸ¥
      if: |
        github.event_name == 'schedule' &&
        contains(github.event.schedule, '0 21 * * 0')
      run: |
        CHECK=$(python -c "import random; print(random.randint(0, 6))")
        echo "å‘¨æ—¥è§¦å‘æ£€æŸ¥ï¼š${CHECK}/6ï¼ˆéœ€ä¸º0ï¼‰"
        if [ $CHECK -ne 0 ]; then
          echo "â­ï¸ è·³è¿‡å‘¨æ—¥ä»»åŠ¡"
          exit 0
        fi

    # ========== æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ==========
    - name: âš™ï¸ ç”Ÿæˆé˜…è¯»å‚æ•°
      run: |
        # æ—¶é—´èŒƒå›´3.4-4.1å°æ—¶ â†’ 204-246åˆ†é’Ÿ
        TOTAL_MIN=$(python -c "import random; print(random.randint(204, 246))")
        
        # é˜…è¯»é—´éš”å‚æ•°ï¼ˆç§’ï¼‰
        BASE_INTERVAL=60
        PAUSE_MIN=30
        PAUSE_MAX=120
        
        # è®¡ç®—æ“ä½œæ¬¡æ•°
        MAX_OPS=$(( TOTAL_MIN * 60 / (BASE_INTERVAL + PAUSE_MAX) ))
        MIN_OPS=$(( TOTAL_MIN * 60 / (BASE_INTERVAL + PAUSE_MIN) ))