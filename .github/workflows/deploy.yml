name: WeRead Stable Bot

on:
  schedule:
    - cron: '0 21 * * 1-6'    # åŒ—äº¬5:00ï¼ˆå‘¨ä¸€è‡³å‘¨å…­ï¼‰
    - cron: '50 3 * * 1-6'    # åŒ—äº¬11:50
    - cron: '0 14 * * 1-6'    # åŒ—äº¬22:00
    - cron: '0 16-23 * * 6'   # åŒ—äº¬å‘¨æ—¥00:00-07:59
    - cron: '0 0-15 * * 0'    # åŒ—äº¬å‘¨æ—¥08:00-23:59

  workflow_dispatch:
    inputs:
      duration:
        description: 'è¿è¡Œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰30-240'
        required: false
        type: number

jobs:
  core_task:
    runs-on: ubuntu-24.04
    env:
      TZ: Asia/Shanghai
      WXPUSHER_SPT: ${{ secrets.WXPUSHER_SPT }}
      PUSH_METHOD: ${{ secrets.PUSH_METHOD }}

    steps:
    # ========================
    # é˜¶æ®µ1ï¼šå‚æ•°é…ç½®
    # ========================
    - name: âš™ï¸ å‚æ•°åˆå§‹åŒ–
      id: config
      run: |
        # æ‰‹åŠ¨æ¨¡å¼å¤„ç†
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ -n "${{ inputs.duration }}" ]]; then
            READ_NUM=${{ inputs.duration }}
            echo "ğŸ› ï¸ æ‰‹åŠ¨æ¨¡å¼ | æ—¶é•¿: $READ_NUM åˆ†é’Ÿ"
          else
            echo "::error::æ‰‹åŠ¨è§¦å‘éœ€æŒ‡å®šdurationå‚æ•°" && exit 1
          fi
        else
          # è‡ªåŠ¨æ¨¡å¼é€»è¾‘
          day=$(date +%u)
          if [[ $day == 7 ]]; then  # å‘¨æ—¥
            READ_NUM=$(( 90 + RANDOM % 151 ))  # 90-240åˆ†é’Ÿ
          else
            READ_NUM=$(( 45 + RANDOM % 76 ))   # 45-120åˆ†é’Ÿ
          fi
        fi

        # å‚æ•°æ ¡éªŒ
        if (( READ_NUM < 30 || READ_NUM > 240 )); then
          echo "::error::æ—¶é•¿è¶…å‡ºèŒƒå›´(30-240): $READ_NUM" && exit 1
        fi

        echo "READ_NUM=$READ_NUM" >> $GITHUB_OUTPUT

    # ========================
    # é˜¶æ®µ2ï¼šæ ¸å¿ƒä»»åŠ¡
    # ========================
    - name: ğŸ¤– æ‰§è¡Œé˜…è¯»ä»»åŠ¡
      env:
        READ_NUM: ${{ steps.config.outputs.READ_NUM }}
      run: |
        echo "âœ… å¼€å§‹æ‰§è¡Œé˜…è¯» | è®¡åˆ’æ—¶é•¿: ${READ_NUM}åˆ†é’Ÿ"
        # å®é™…ä»»åŠ¡ç¤ºä¾‹ï¼ˆæ›¿æ¢ä¸ºä½ çš„çœŸå®é€»è¾‘ï¼‰
        for ((i=1; i<=READ_NUM; i++)); do
          echo "[${i}/${READ_NUM}] æ­£åœ¨é˜…è¯»..."
          sleep 60  # æ¨¡æ‹Ÿæ¯åˆ†é’Ÿè¿›åº¦
        done

    # ========================
    # é˜¶æ®µ3ï¼šé€šçŸ¥ç³»ç»Ÿ
    # ========================
    - name: ğŸ“¢ å¾®ä¿¡æ¨é€æŠ¥å‘Š
      if: always()
      env:
        TOPIC_ID: ${{ secrets.WXPUSHER_TOPIC_ID }}
        UID_LIST: ${{ secrets.WXPUSHER_UIDS }}
      run: |
        # æ„å»ºæ¶ˆæ¯å†…å®¹
        status="${{ job.status }}"
        run_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        msg="å¾®ä¿¡è¯»ä¹¦ä»»åŠ¡æŠ¥å‘Šï¼š
        â¤ çŠ¶æ€: ${status^^}
        â¤ æ‰§è¡Œæ—¶é•¿: ${{ env.READ_NUM }}åˆ†é’Ÿ
        â¤ æ—¥å¿—è¯¦æƒ…: $run_url"

        # å‘é€è¯·æ±‚
        case "$PUSH_METHOD" in
          topic)
            curl -sS -X POST "https://wxpusher.zjiecode.com/api/send/message" &#92;
              -H "Content-Type: application/json" &#92;
              -d '{
                "appToken": "'"$WXPUSHER_SPT"'",
                "content": "'"$msg"'",
                "contentType": 3,
                "topicIds": ['"$TOPIC_ID"']
              }' ;;
          uid)
            IFS=',' read -ra UIDS <<< "$UID_LIST"
            for uid in "${UIDS[@]}"; do
              curl -sS -X POST "https://wxpusher.zjiecode.com/api/send/message" &#92;
                -d "appToken=$WXPUSHER_SPT&content=$msg&contentType=3&uids=$uid"
              sleep 0.5
            done ;;
          *)
            echo "::error::æœªçŸ¥æ¨é€æ–¹å¼: $PUSH_METHOD" && exit 1 ;;
        esac

        echo "é€šçŸ¥å‘é€çŠ¶æ€ç : $?"
