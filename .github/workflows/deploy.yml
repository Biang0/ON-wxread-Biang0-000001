name: wxread

on:
  schedule:
    - cron: '00 14 * * *'         # 北京时间 22:00（UTC 14:00）
    - cron: '0 21 * * *'          # 北京时间 5:00（UTC 21:00）
    - cron: '40 3 * * *'          # 北京时间 11:40（UTC 3:40）
    - cron: '0 9 * * sat,sun'     # 北京时间 17:00（UTC 9:00，仅周末）
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead  # 指定环境

    steps:

    - name: Set DNS to Google's DNS
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf  

    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install certifi==2024.8.30 charset-normalizer==3.4.0 idna==3.10 requests==2.32.3 urllib3==2.2.3

    - name: Random delay between 0-30 分钟
      run: |
        DELAY=$((RANDOM % 1))    
        echo "Delaying for $DELAY minutes..."
        sleep $((DELAY * 60))

    - name: Generate random READ_NUM
  run: |
    # ======================
    #  时间计算模块
    # ======================
    CURRENT_UTC=$(date -u "+% Y-% m-% d % H:% M UTC")
    BEIJING_TIME=$(date -d "+8 hours" "+% Y-% m-% d % H:% M CST")
    
    echo " 系统时间报告:"
    echo "-------------------------------------"
    echo "| UTC 时间  : ${CURRENT_UTC}"
    echo "| 北京时间  : ${BEIJING_TIME}"
    echo "-------------------------------------"

    # ======================
    #  随机数生成逻辑
    # ======================
    WEEKDAY=$(date +% u)
    
    if [[$WEEKDAY -ge 6]]; then
        # 周末配置（180~300 → 90~150 分钟）
        RANDOM_NUM=$((RANDOM % 121 + 180))  
        TIMING_TYPE=" 周末延长时段"
    else
        # 工作日配置（120~180 → 60~90 分钟）
        RANDOM_NUM=$((RANDOM % 61 + 120))
        TIMING_TYPE=" 常规工作日段"
    fi

    # ======================
    #  时长换算显示
    # ======================
    TOTAL_SECONDS=$((RANDOM_NUM * 30))
    MINUTES=$((TOTAL_SECONDS / 60))
    SECONDS=$((TOTAL_SECONDS % 60))
    
    # 格式化时间显示
    DURATION_DISPLAY=$(printf "%02d 分 %02d 秒" "$MINUTES" "$SECONDS")
    DURATION_DECIMAL=$(awk "BEGIN {printf &#92;"%.1f&#92;", $TOTAL_SECONDS / 60}")

    echo " 生成报告:"
    echo "-------------------------------------"
    echo "| 时段类型  : ${TIMING_TYPE}"
    echo "| 原始数值  : ${RANDOM_NUM} 单位"
    echo "| 标准时长  : ${DURATION_DISPLAY}"
    echo "| 精确时长  : ${DURATION_DECIMAL} 分钟"
    echo "-------------------------------------"
    
    echo "READ_NUM=${RANDOM_NUM}" >> $GITHUB_ENV

 

    - name: Run deployment script
      env:
        WXREAD_CURL_BASH: ${{secrets.WXREAD_CURL_BASH}}
        PUSH_METHOD: ${{secrets.PUSH_METHOD}}  
        PUSHPLUS_TOKEN: ${{secrets.PUSHPLUS_TOKEN}}
        WXPUSHER_SPT: ${{secrets.WXPUSHER_SPT}}    
        TELEGRAM_BOT_TOKEN: ${{secrets.TELEGRAM_BOT_TOKEN}}
        TELEGRAM_CHAT_ID: ${{secrets.TELEGRAM_CHAT_ID}}
        READ_NUM: ${{env.READ_NUM}}
      run: |
        python main.py
