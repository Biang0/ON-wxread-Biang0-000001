name: WeRead Automation

on:
  schedule:
    # ==============================================
    # 日常任务（周一到周六 北京时间）
    # ==============================================
    - cron: '0 21 * * 1-6'    # UTC 21:00 → 北京5:00（次日）
    - cron: '40 3 * * 1-6'    # UTC 3:40 → 北京11:40
    - cron: '0 14 * * 1-6'    # UTC 14:00 → 北京22:00

    # ==============================================
    # 周日任务入口（UTC周六16点 → 北京周日0点）
    # ==============================================
    - cron: '0 16 * * 6'

  workflow_dispatch:
    inputs:
      mode:
        description: '运行模式 [auto:智能模式 / manual:手动调试]'
        required: false
        default: 'auto'

jobs:
  daily_task:
    name: 日常阅读任务（周一到六）
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    # ------------------------------
    # 初始化环境
    # ------------------------------
    - name: 🔧 检出代码库
      uses: actions/checkout@v4

    # ------------------------------
    # 时段识别模块
    # ------------------------------
    - name: 🕒 识别触发时段
      id: time_period
      run: |
        case "${{ github.event.schedule }}" in
          *'0 21 * * '*)
            echo "PERIOD=morning" >> $GITHUB_ENV
            echo "🕖 时段：早间（北京5:00）" ;;
          *'40 3 * * '*)
            echo "PERIOD=noon" >> $GITHUB_ENV
            echo "🕦 时段：午间（北京11:40）" ;;
          *'0 14 * * '*)
            echo "PERIOD=night" >> $GITHUB_ENV
            echo "🕙 时段：晚间（北京22:00）" ;;
        esac

    # ------------------------------
    # 阅读参数生成器
    # ------------------------------
    - name: 🎯 生成阅读参数
      run: |
        # 每日总配额：3.8小时 → 456次数（228分钟×2次/分钟）
        DAILY_QUOTA=456
        
        case $PERIOD in
          morning)
            # 早间：45-75分钟（90-150次）
            NUM=$((90 + RANDOM % 61)) ;;
          noon)
            # 午间：60-90分钟（120-180次）
            NUM=$((120 + RANDOM % 61)) ;;
          night)
            # 晚间：动态补充剩余额度
            REMAINING=$((DAILY_QUOTA - (90 + 120)))
            NUM=$(( REMAINING > 0 ? REMAINING : 120 )) ;;
        esac

        echo "READ_NUM=$NUM" >> $GITHUB_ENV
        echo "📈 生成参数：$NUM 次（等效 $((NUM/2)) 分钟）"

    # ------------------------------
    # 任务执行模块（带防御性检查）
    # ------------------------------
    - name: 🚀 执行阅读行为
      env:
        API_ENDPOINT: ${{ secrets.READ_API_ENDPOINT }}
        READ_NUM: ${{ env.READ_NUM }}
      run: |
        # 防御性检查
        if [ -z "$API_ENDPOINT" ]; then
          echo "❌ 错误：未检测到API端点配置"
          exit 1
        fi

        if [ -z "$READ_NUM" ]; then
          echo "❌ 错误：阅读次数未生成"
          exit 1
        fi

        # 带重试机制的请求
        for i in {1..3}; do
          curl -sS -m 30 -H "User-Agent: Mozilla/5.0" &#92;
            "${API_ENDPOINT}?num=$READ_NUM" && break
          echo "⚠️ 请求失败，10秒后重试..."
          sleep 10
        done

  sunday_task:
    name: 周日全随机任务
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    # ------------------------------
    # 时区配置模块
    # ------------------------------
    - name: 🌐 配置上海时区
      run: |
        sudo apt-get update
        sudo apt-get install -y tzdata
        echo "Asia/Shanghai" | sudo tee /etc/timezone
        sudo dpkg-reconfigure -f noninteractive tzdata

    # ------------------------------
    # 时间验证模块
    # ------------------------------
    - name: 🕐 验证北京时间
      run: |
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        BEIJING_DAY=$(TZ='Asia/Shanghai' date +%u)
        
        echo "当前北京时间: $BEIJING_TIME"
        if [ "$BEIJING_DAY" -ne 7 ]; then
          echo "❌ 校验失败：当前非北京时间周日"
          exit 1
        fi
        echo "✅ 时间校验通过：北京时间周日"

    # ------------------------------
    # 随机延迟模块
    # ------------------------------
    - name: ⏳ 生成全随机延迟
      run: |
        # 生成0-1439分钟随机延迟（覆盖全天）
        DELAY=$(( RANDOM % 1440 ))
        HOURS=$(( DELAY / 60 ))
        MINUTES=$(( DELAY % 60 ))
        
        echo "⏱️ 延迟设置：${DELAY}分钟（${HOURS}小时${MINUTES}分）"
        sleep $(( DELAY * 60 ))

    # ------------------------------
    # 周日参数生成
    # ------------------------------
    - name: 🎲 生成阅读参数
      run: |
        NUM=$((120 + RANDOM % 121))  # 120-240次（60-120分钟）
        echo "READ_NUM=$NUM" >> $GITHUB_ENV
        echo "🔔 周日阅读量：$NUM 次（等效 $((NUM/2)) 分钟）"

    # ------------------------------
    # 请求执行模块
    # ------------------------------
    - name: 🚀 执行周日任务
      env:
        API_ENDPOINT: ${{ secrets.READ_API_ENDPOINT }}
        READ_NUM: ${{ env.READ_NUM }}
      run: |
        # 获取实际执行时间
        EXEC_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        echo "🕒 实际执行时间：$EXEC_TIME"
        
        # 带调试信息的请求
        curl -v -sS -m 60 -H "User-Agent: Mozilla/5.0" &#92;
          "${API_ENDPOINT}?num=$READ_NUM"
