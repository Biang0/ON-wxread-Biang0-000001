name: wxread

on:
  schedule:
    - cron: '0 21 * * *'   # 北京5:00
    - cron: '40 3 * * *'   # 北京11:40
    - cron: '0 14 * * *'   # 北京22:00
  workflow_dispatch:
    inputs:
      mode:
        description: '运行模式 (auto/manual)'
        required: false
        default: 'auto'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    # ----------------- 初始化阶段 -----------------
    - name: 🔧 DNS配置
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
        echo "✅ DNS配置完成"

    - name: 📥 代码检出
      uses: actions/checkout@v4
      with:
        path: main-repo  # 指定检出目录

    # ---------------- 环境准备 --------------------
    - name: 🐍 Python 3.10环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'  # 保留缓存机制
        cache-dependency-path: ''  # 显式禁用requirements.txt检查

    - name: 📦 安装依赖
      run: |
        cd main-repo  # 进入检出目录
        python -m pip install --upgrade pip
        # 直接指定依赖版本（替代requirements.txt）
        pip install requests==2.32.3 urllib3==2.2.3 certifi==2024.8.30 charset-normalizer==3.4.0
        echo "✅ 已安装依赖：$(pip list | grep requests)"

    # ---------------- 执行控制 --------------------
    - name: ⏳ 随机延迟
      run: |
        DELAY=$((RANDOM % 21))
        echo "生成延迟：${DELAY}分钟"
        sleep $((DELAY * 60))
        echo "延迟执行完成"

    - name: 🕒 生成阅读参数
      run: |
        case "${{ github.event.schedule }}" in
          '0 21 * * *')
            NUM=$((RANDOM % 41 + 90))  # 45-65分钟
            echo "🌅 早间任务 | 范围：90-130" ;;
          '40 3 * * *')
            NUM=$((RANDOM % 61 + 120))  # 60-90分钟
            echo "🌞 午间任务 | 范围：120-180" ;;
          '0 14 * * *')
            NUM=$((RANDOM % 61 + 180))  # 90-120分钟
            echo "🌙 晚间任务 | 范围：180-240" ;;
          *)
            NUM=150
            echo "⚠️ 使用默认值" ;;
        esac
        echo "READ_NUM=$NUM" >> $GITHUB_ENV

    - name: 🚀 执行主程序
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
      working-directory: main-repo  # 指定工作目录
      run: python main.py
