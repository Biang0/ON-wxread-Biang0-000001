name: wxread

on:
  schedule:
    - cron: '00 14 * * *'         # åŒ—äº¬22:00
    - cron: '0 21 * * *'          # åŒ—äº¬5:00
    - cron: '40 3 * * *'          # åŒ—äº¬11:40
    - cron: '0 9 * * sat,sun'     # å‘¨æœ«17:00
    - cron: '0 0 * * 1'           # å‘¨ä¸€8:00
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'

jobs:
  wxread-automation:
    runs-on: ubuntu-latest
    environment: AutoRead
    timeout-minutes: 45

    steps:
    - name: ğŸ› ï¸ ç¯å¢ƒåˆå§‹åŒ–
      run: |
        sudo sed -i '1i nameserver 8.8.8.8' /etc/resolv.conf
        sudo sed -i '1i nameserver 8.8.4.4' /etc/resolv.conf
        echo "âœ… DNSé…ç½®å®Œæˆ | $(date '+%Y-%m-%d %H:%M:%S')"

    - name: ğŸ“š ä»£ç æ£€å‡º
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ğŸ Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ ä¾èµ–ç®¡ç†
      run: |
        python -m pip install --upgrade pip
        pip install requests==2.32.3 urllib3==2.2.3
        echo "ä¾èµ–æ£€æŸ¥: $(pip freeze | grep 'requests&#92;|urllib3')"

    - name: â³ æ™ºèƒ½å»¶è¿Ÿ
      run: |
        jitter=$(( RANDOM % 1200 ))
        echo "éšæœºå»¶è¿Ÿ: $((jitter / 60))åˆ†$((jitter % 60))ç§’"
        sleep $jitter

    - name: ğŸ¯ æ¡ä»¶æ‰§è¡Œæ§åˆ¶
      id: condition-check
      if: |
        github.event_name == 'schedule' && 
        github.event.schedule == '0 0 * * 1'
      run: |
        seed=$(($(date +%s) % 7))
        echo "å‘¨éšæœºæ•°: $seed"
        if [ $seed -eq 0 ]; then
          echo "æ‰§è¡Œæ ‡è¯†=true" >> $GITHUB_OUTPUT
        else
          echo "æ‰§è¡Œæ ‡è¯†=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ”¢ æ—¶é•¿ç”Ÿæˆå™¨
      id: time-generator
      env:
        TRIGGER_MODE: ${{ inputs.mode || 'auto' }}
      run: |
        case "${{ github.event.schedule }}" in
          '0 21 * * *')   # æ—©é—´ä»»åŠ¡
            range=(90 150) ;;
          '40 3 * * *')   # åˆé—´ä»»åŠ¡
            range=(120 180) ;;
          '00 14 * * *')  # æ™šé—´ä»»åŠ¡
            range=(120 180) ;;
          '0 9 * * sat,sun') # å‘¨æœ«
            range=(120 180) ;;
          '0 0 * * 1')    # å‘¨éšæœº
            range=(120 240) ;;
          *)              # é»˜è®¤å®‰å…¨å€¼
            range=(120 180) ;;
        esac

        if [[ "$TRIGGER_MODE" == "manual" ]]; then
          duration=$(shuf -i 90-180 -n 1)
        else
          spread=$((range[1] - range[0]))
          offset=$((RANDOM % (spread + 1)))
          duration=$((range[0] + offset))
        fi

        echo "ç”Ÿæˆæ•°å€¼: $duration (ç­‰æ•ˆ$((duration/2))åˆ†é’Ÿ)"
        echo "READ_DURATION=$duration" >> $GITHUB_ENV

    - name: ğŸš€ æ ¸å¿ƒæ‰§è¡Œ
      if: |
        (github.event_name != 'schedule') || 
        (github.event.schedule != '0 0 * * 1') || 
        steps.condition-check.outputs.æ‰§è¡Œæ ‡è¯† == 'true'
      env:
        WXREAD_TOKEN: ${{ secrets.WXREAD_AUTH_TOKEN }}
        EXEC_TIMEOUT: ${{ env.READ_DURATION }}
      run: |
        start_ts=$(date +%s)
        echo "â–¶ï¸ å¼€å§‹æ‰§è¡Œ | é¢„æœŸæ—¶é•¿: ${EXEC_TIMEOUT}ç§’"
        
        # æ¨¡æ‹Ÿæ‰§è¡Œï¼ˆæ›¿æ¢å®é™…ä¸šåŠ¡é€»è¾‘ï¼‰
        sleep $((EXEC_TIMEOUT / 2))
        
        end_ts=$(date +%s)
        echo "âœ… æ‰§è¡Œå®Œæˆ | å®é™…è€—æ—¶: $((end_ts - start_ts))ç§’"

    - name: ğŸ“Š ç»“æœæŠ¥å‘Š
      if: always()
      run: |
        echo "=== æ‰§è¡Œæ‘˜è¦ ==="
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "è¾“å…¥æ¨¡å¼: ${{ inputs.mode || 'auto' }}"
        echo "å®šæ—¶è§„åˆ™: ${{ github.event.schedule || 'æ‰‹åŠ¨è§¦å‘' }}"
        echo "ç”Ÿæˆæ—¶é•¿: ${{ env.READ_DURATION }}ç§’"
