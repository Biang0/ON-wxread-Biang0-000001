name: WeRead Bot with WxPusher

on:
  schedule:
    - cron: '0 21 * * 1-6'    # åŒ—äº¬å‘¨äºŒåˆ°å‘¨å…­ 05:00
    - cron: '50 3 * * 1-6'    # åŒ—äº¬11:50
    - cron: '0 14 * * 1-6'    # åŒ—äº¬22:00
    - cron: '0 16-23 * * 6'   # åŒ—äº¬å‘¨æ—¥00:00-07:59
    - cron: '0 0-15 * * 0'    # åŒ—äº¬å‘¨æ—¥08:00-23:59

  workflow_dispatch:
    inputs:
      duration:
        description: 'è¿è¡Œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰30-240'
        required: false
        type: number

jobs:
  wxread_task:
    runs-on: ubuntu-24.04
    env:
      TZ: Asia/Shanghai
      WXPUSHER_SPT: ${{ secrets.WXPUSHER_SPT }}  # WxPusher appToken
      PUSH_METHOD: ${{ secrets.PUSH_METHOD }}    # æ¨é€æ–¹å¼ï¼ˆtopic/uidï¼‰

    steps:
    # ========================
    # é˜¶æ®µ1ï¼šå‚æ•°åˆå§‹åŒ–
    # ========================
    - name: âš™ï¸ å‚æ•°åˆå§‹åŒ–
      id: config
      run: |
        # æ‰‹åŠ¨æ¨¡å¼å¤„ç†
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          READ_NUM=${{ inputs.duration || 60 }}
        else
          # è‡ªåŠ¨æ¨¡å¼ç”Ÿæˆéšæœºæ—¶é•¿
          day=$(date +%u)
          if [[ $day == 7 ]]; then  # å‘¨æ—¥
            READ_NUM=$(( 90 + RANDOM % 151 ))  # 90-240åˆ†é’Ÿ
          else
            READ_NUM=$(( 45 + RANDOM % 76 ))   # 45-120åˆ†é’Ÿ
          fi
        fi

        # å‚æ•°æ ¡éªŒ
        if (( READ_NUM < 30 || READ_NUM > 240 )); then
          echo "::error::æ— æ•ˆæ—¶é•¿: $READ_NUM" && exit 1
        fi

        # ç”Ÿæˆè¾“å‡ºå‚æ•°
        echo "READ_NUM=$READ_NUM" >> $GITHUB_OUTPUT
        echo "DELAY=$(( RANDOM % 16 ))" >> $GITHUB_ENV  # éšæœºå»¶è¿Ÿ0-15åˆ†é’Ÿ

    # ========================
    # é˜¶æ®µ2ï¼šå»¶è¿Ÿæ‰§è¡Œ
    # ========================
    - name: â³ æ‰§è¡Œå»¶è¿Ÿ
      if: env.DELAY > 0
      run: |
        echo "â±ï¸ æ·»åŠ éšæœºå»¶è¿Ÿ ${{ env.DELAY }} åˆ†é’Ÿ"
        sleep $(( ${{ env.DELAY }} * 60 ))

    # ========================
    # é˜¶æ®µ3ï¼šæ ¸å¿ƒä»»åŠ¡æ‰§è¡Œ
    # ========================
    - name: ğŸ¤– æ‰§è¡Œé˜…è¯»ä»»åŠ¡
      env:
        READ_NUM: ${{ steps.config.outputs.READ_NUM }}
      run: |
        # æ­¤å¤„åº”è°ƒç”¨ä½ çš„å®é™…è„šæœ¬
        echo "âœ… æ¨¡æ‹Ÿé˜…è¯»å®Œæˆ | æ—¶é•¿: ${READ_NUM}åˆ†é’Ÿ"
        # python main.py --duration $READ_NUM

    # ========================
    # é˜¶æ®µ4ï¼šé€šçŸ¥ç³»ç»Ÿ
    # ========================
    - name: ğŸ“¢ æ¨é€é€šçŸ¥
      if: always()  # å§‹ç»ˆæ‰§è¡Œ
      run: |
        # æ„å»ºæ¶ˆæ¯å†…å®¹
        status=${{ job.status }}
        run_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        msg="ä»»åŠ¡çŠ¶æ€: ${status^^}&#92;næ—¶é•¿: ${{ env.READ_NUM }}åˆ†é’Ÿ&#92;nè¯¦æƒ…: ${run_url}"

        # æ ¹æ®æ¨é€æ–¹å¼æ„é€ å‚æ•°
        if [[ "$PUSH_METHOD" == "topic" ]]; then
          topic_ids=${{ secrets.WXPUSHER_TOPIC_ID }}
          post_data="&#92;"topicIds&#92;": [${topic_ids}]"
        elif [[ "$PUSH_METHOD" == "uid" ]]; then
          uids=${{ secrets.WXPUSHER_UIDS }}
          post_data="&#92;"uids&#92;": [&#92;"${uids}&#92;"]"
        else
          echo "::error::æœªçŸ¥æ¨é€æ–¹å¼" && exit 1
        fi

        # å‘é€WxPusherè¯·æ±‚
        curl -X POST "https://wxpusher.zjiecode.com/api/send/message" &#92;
          -H "Content-Type: application/json" &#92;
          -d '{
            "appToken": "'"$WXPUSHER_SPT"'",
            "content": "'"$msg"'",
            "contentType": 3,
            '${post_data}'
          }'
