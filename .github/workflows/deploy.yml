name: wxread

on:
  schedule:
    # UTC时间换算（北京时间=UTC+8）
    - cron: '0 21 * * *'   # 北京5:00（21+8=29→5:00）
    - cron: '40 3 * * *'   # 北京11:40（3+8=11）
    - cron: '0 14 * * *'   # 北京22:00（14+8=22）
  workflow_dispatch:
    inputs:
      mode:
        description: '运行模式 (auto/manual)'
        required: false
        default: 'auto'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    # ----------------- 初始化阶段 -----------------
    - name: 🌐 网络配置
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
        echo "✅ DNS配置完成 | Google DNS生效"

    - name: 📦 代码仓库检出
      uses: actions/checkout@v4
      with:
        persist-credentials: false

    # ---------------- 环境准备 --------------------
    - name: 🐍 Python环境初始化
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: 📚 依赖安装
      run: |
        pip install -r requirements.txt
        echo "🔍 验证安装 | $(pip show requests | grep Version)"

    # ---------------- 执行控制 --------------------
    - name: 🎲 随机延迟
      run: |
        DELAY=$(( RANDOM % 21 ))  # 0-20分钟随机延迟
        echo "⏳ 延迟设置：${DELAY}分钟"
        sleep $(( DELAY * 60 ))
        echo "⏰ 实际延迟：${DELAY}分钟"

    - name: 🕒 阅读时长生成
      run: |
        case "${{ github.event.schedule }}" in
          '0 21 * * *')   # 早间任务
            # 45-65分钟 → 90-130 READ_NUM
            NUM=$(( RANDOM % 41 + 90 ))  # 41=130-90+1
            echo "🌅 早间任务 | 范围：90-130（45-65分钟）" ;;
          '40 3 * * *')   # 午间任务
            NUM=$(( RANDOM % 61 + 120 ))  # 120-180（60-90分钟）
            echo "🌞 午间任务 | 范围：120-180" ;;
          '0 14 * * *')   # 晚间任务
            NUM=$(( RANDOM % 61 + 180 ))  # 180-240（90-120分钟）
            echo "🌙 晚间任务 | 范围：180-240" ;;
          *)
            NUM=120  # 安全默认值
            echo "⚠️ 未知触发类型 | 使用默认值" ;;
        esac

        # 强制早间范围限制
        if [[ "${{ github.event.schedule }}" == '0 21 * * *' ]]; then
          NUM=$(( NUM < 90 ? 90 : NUM ))  # 下限保护
          NUM=$(( NUM > 130 ? 130 : NUM ))  # 上限保护
        fi
        
        echo "📊 生成数值：READ_NUM=${NUM}（等效 $((NUM/2)) 分钟）"
        echo "READ_NUM=$NUM" >> $GITHUB_ENV

    - name: 🚀 执行阅读脚本
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
      run: |
        python main.py
        echo "🔚 脚本退出码：$?"

    # ---------------- 结果验证 --------------------
    - name: 📝 早间任务验证
      if: contains(github.event.schedule, '0 21 * * *')
      run: |
        if [ $READ_NUM -lt 90 ] || [ $READ_NUM -gt 130 ]; then
          echo "❌ 数值异常 | 实际值：$READ_NUM"
          exit 1
        else
          echo "✅ 合规检查通过 | 有效范围：90-130"
        fi
