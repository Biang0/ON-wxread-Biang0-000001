name: WXRead-Scheduler

on:
  schedule:
    # åŒ—äº¬æ—¶åŒºä»»åŠ¡ (UTC+8)
    - cron: '0 21 * * 1-6'    # å‘¨ä¸€è‡³å‘¨å…­ 05:00 (UTC 21:00)
      timezone: Asia/Shanghai
    - cron: '45 3 * * 1-6'    # å‘¨ä¸€è‡³å‘¨å…­ 11:45 (UTC 03:45)
      timezone: Asia/Shanghai
    - cron: '0 14 * * 1-6'    # å‘¨ä¸€è‡³å‘¨å…­ 22:00 (UTC 14:00)
      timezone: Asia/Shanghai
    - cron: '0 21 * * 0'      # å‘¨æ—¥ 05:00 (UTC å‘¨å…­21:00)
      timezone: Asia/Shanghai
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'

jobs:
  wxread-task:
    runs-on: ubuntu-22.04
    environment: Production
    timeout-minutes: 360

    steps:
    - name: ðŸ› ï¸ åˆå§‹åŒ–çŽ¯å¢ƒ
      run: |
        # å¤‡ä»½å¹¶è®¾ç½®DNS
        sudo cp /etc/resolv.conf /etc/resolv.conf.backup
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf

    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt

    - name: â³ åˆå§‹éšæœºå»¶è¿Ÿ
      run: |
        DELAY=$(python -c "import random; print(random.randint(0, 20))")
        echo "ç”Ÿæˆåˆå§‹å»¶è¿Ÿ: ${DELAY}åˆ†é’Ÿ"
        sleep $(($DELAY * 60))

    - name: ðŸŽ¯ å‘¨æ—¥ä»»åŠ¡æ£€æŸ¥
      if: |
        github.event_name == 'schedule' &&
        contains(github.event.schedule, '0 21 * * 0')
      run: |
        CHECK=$(python -c "import random; print(random.randint(0, 6))")
        echo "å‘¨æ—¥è§¦å‘æ£€æŸ¥: ${CHECK}/6 (éœ€ç­‰äºŽ0)"
        if [ $CHECK -ne 0 ]; then
          echo "è·³è¿‡å‘¨æ—¥ä»»åŠ¡"
          exit 0
        fi

    - name: âš™ï¸ ç”Ÿæˆä»»åŠ¡å‚æ•°
      run: |
        # æ—¶é—´èŒƒå›´3.4-4.1å°æ—¶ â†’ 204-246åˆ†é’Ÿ
        TOTAL_MIN=$(python -c "import random; print(random.randint(204, 246))")
        
        # é˜…è¯»é—´éš”å‚æ•°
        BASE_INTERVAL=60      # åŸºç¡€æ“ä½œé—´éš”ï¼ˆç§’ï¼‰
        PAUSE_MIN=30          # æœ€å°åœé¡¿æ—¶é—´
        PAUSE_MAX=120         # æœ€å¤§åœé¡¿æ—¶é—´
        
        # è®¡ç®—æ“ä½œæ¬¡æ•°èŒƒå›´
        MAX_OPS=$(( $TOTAL_MIN * 60 / ($BASE_INTERVAL + $PAUSE_MAX) ))
        MIN_OPS=$(( $TOTAL_MIN * 60 / ($BASE_INTERVAL + $PAUSE_MIN) ))
        FINAL_OPS=$(python -c "import random; print(random.randint($MAX_Ops, $MIN_Ops))")
        
        # è¾“å‡ºå‚æ•°
        echo "æ€»æ—¶é•¿: ${TOTAL_MIN}åˆ†é’Ÿ"
        echo "æ“ä½œæ¬¡æ•°: ${FINAL_OPS}"
        echo "READ_OPS=${FINAL_OPS}" >> $GITHUB_ENV
        echo "PAUSE_MIN=${PAUSE_MIN}" >> $GITHUB_ENV
        echo "PAUSE_RANGE=$(( $PAUSE_MAX - $PAUSE_MIN ))" >> $GITHUB_ENV

    - name: ðŸ“š æ‰§è¡Œé˜…è¯»ä»»åŠ¡
      env:
        API_TOKEN: ${{ secrets.WXREAD_API }}
      run: |
        set -euo pipefail
        MAX_RETRY=3
        
        for ((i=1; i<=$READ_OPS; i++)); do
          retry=0
          while [ $retry -lt $MAX_RETRY ]; do
            # ç”Ÿæˆéšæœºåœé¡¿
            PAUSE=$(python -c "import random; print($PAUSE_MIN + random.randint(0, $PAUSE_RANGE))")
            
            echo "æ“ä½œ ${i}/${READ_OPS} | åœç•™ ${PAUSE}s"
            
            # æ¨¡æ‹Ÿé˜…è¯»è¡Œä¸º
            curl -sS -H "Authorization: Bearer $API_TOKEN" &#92;
              "https://api.example.com/read?action=next"
            
            # é”™è¯¯é‡è¯•æœºåˆ¶
            if [ $? -eq 0 ]; then
              sleep $PAUSE
              break
            else
              retry=$((retry+1))
              echo "è¯·æ±‚å¤±è´¥ï¼Œé‡è¯• ${retry}/${MAX_RETRY}"
              sleep 5
            fi
          done
          
          if [ $retry -eq $MAX_RETRY ]; then
            echo "âŒ è¿žç»­å¤±è´¥è¶…è¿‡${MAX_RETRY}æ¬¡"
            exit 1
          fi
        done

    - name: ðŸ“Š ç”ŸæˆæŠ¥å‘Š
      if: always()
      run: |
        echo "### ä»»åŠ¡æ‰§è¡ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- è§¦å‘æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- è¿è¡Œæ¨¡å¼: ${{ github.event.inputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- æ€»æ“ä½œæ¬¡æ•°: ${READ_OPS:-0}" >> $GITHUB_STEP_SUMMARY
        echo "- æœ€ç»ˆçŠ¶æ€: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
