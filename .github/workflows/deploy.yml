name: wxread

on:
  schedule:
    - cron: '00 14 * * *'           # æ™šé—´ä»»åŠ¡ï¼š22:00ï¼ˆæ¯å¤©ï¼‰
    - cron: '0 21 * * 1-5'          # æ—©é—´ä»»åŠ¡ï¼š05:00ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰
    - cron: '40 3 * * 1-5'          # åˆé—´ä»»åŠ¡ï¼š11:40ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰
    - cron: '0 9 * * sat,sun'       # å‘¨æœ«ä»»åŠ¡ï¼š17:00ï¼ˆå‘¨å…­/æ—¥ï¼‰
    - cron: '0 0 * * sat,sun'       # å‘¨éšæœºä»»åŠ¡ï¼š08:00ï¼ˆå‘¨æœ«ï¼‰
  workflow_dispatch:
    description: æ‰‹åŠ¨è§¦å‘å¾®ä¿¡é˜…è¯»ä»»åŠ¡ï¼ˆé»˜è®¤ä¸å»¶è¿Ÿï¼‰
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'manual'   # ä¿®æ”¹é»˜è®¤å€¼ä¸º manualï¼Œé¿å…æ‰‹åŠ¨è§¦å‘æ—¶æœ‰éšæœºå»¶è¿Ÿ

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½® Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: â±ï¸ éšæœºå»¶è¿Ÿï¼ˆä»…é™è‡ªåŠ¨æ¨¡å¼ï¼‰
      if: github.event.inputs.mode == 'auto'
      run: |
        DELAY=$((RANDOM % 21))
        echo "â³ ç”Ÿæˆçš„éšæœºå»¶è¿Ÿï¼š${DELAY} åˆ†é’Ÿ"
        sleep $((DELAY * 60))
        echo "âœ… å»¶è¿Ÿæ‰§è¡Œå®Œæˆ"

    - name: ğŸš€ æ‰§è¡Œä¸»ç¨‹åº
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
      run: |
        echo "=== æ‰§è¡Œå‚æ•° ==="
        echo "READ_NUM: ${{ env.READ_NUM }}"
        python main.py || (echo "âŒ è¿è¡Œå¤±è´¥ï¼Œæ¨é€é€šçŸ¥..." && python -c "from push import push; push('âŒ å¾®ä¿¡é˜…è¯»ä»»åŠ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼', '${{ secrets.PUSH_METHOD }}')" && exit 1)