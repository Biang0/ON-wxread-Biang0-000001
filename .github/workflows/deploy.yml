name: WeRead AutoBot Pro

on:
  schedule:
    - cron: '0 21 * * 1-6'    # åŒ—äº¬5:00ï¼ˆå‘¨ä¸€è‡³å‘¨å…­ï¼‰
    - cron: '50 3 * * 1-6'    # åŒ—äº¬11:50
    - cron: '0 14 * * 1-6'    # åŒ—äº¬22:00
    - cron: '0 16-23 * * 6'   # åŒ—äº¬å‘¨æ—¥00:00-07:59
    - cron: '0 0-15 * * 0'    # åŒ—äº¬å‘¨æ—¥08:00-23:59

  workflow_dispatch:
    inputs:
      duration:
        description: 'è¿è¡Œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰30-240'
        required: false
        type: number

jobs:
  core_task:
    runs-on: ubuntu-24.04
    env:
      TZ: Asia/Shanghai
      WXPUSHER_SPT: ${{ secrets.WXPUSHER_SPT }}
      PUSH_METHOD: ${{ secrets.PUSH_METHOD }}
      WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}

    steps:
    # ========================
    # é˜¶æ®µ1ï¼šç¯å¢ƒå‡†å¤‡
    # ========================
    - name: ğŸ›  æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests cryptography

    # ========================
    # é˜¶æ®µ2ï¼šåŠ¨æ€å‚æ•°é…ç½®
    # ========================
    - name: âš™ï¸ å‚æ•°å¼•æ“
      id: config
      run: |
        # æ‰‹åŠ¨æ¨¡å¼å¤„ç†
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ -n "${{ inputs.duration }}" ]]; then
            READ_NUM=$(( ${{ inputs.duration }} * 2 ))  # è½¬æ¢ä¸ºé˜…è¯»æ¬¡æ•°
            echo "ğŸ› ï¸ æ‰‹åŠ¨æ¨¡å¼ | æ¬¡æ•°: $READ_NUM"
          else
            echo "::error::æ‰‹åŠ¨è§¦å‘éœ€æŒ‡å®šdurationå‚æ•°" && exit 1
          fi
        else
          # è‡ªåŠ¨æ¨¡å¼é€»è¾‘
          day=$(date +%u)
          if [[ $day == 7 ]]; then  # å‘¨æ—¥
            READ_NUM=$(( 180 + RANDOM % 121 ))  # 180-300æ¬¡ï¼ˆ90-150åˆ†é’Ÿï¼‰
          else
            READ_NUM=$(( 90 + RANDOM % 61 ))    # 90-150æ¬¡ï¼ˆ45-75åˆ†é’Ÿï¼‰
          fi
        fi

        # å‚æ•°æ ¡éªŒ
        if (( READ_NUM < 60 || READ_NUM > 300 )); then
          echo "::error::å‚æ•°è¶Šç•Œ(60-300): $READ_NUM" && exit 1
        fi

        echo "READ_NUM=$READ_NUM" >> $GITHUB_ENV
        echo "::notice::ç”Ÿæˆé˜…è¯»æ¬¡æ•°: $READ_NUM"

    # ========================
    # é˜¶æ®µ3ï¼šæ ¸å¿ƒæ‰§è¡Œé€»è¾‘
    # ========================
    - name: ğŸ¤– æ‰§è¡Œé˜…è¯»ä»»åŠ¡
      env:
        READ_NUM: ${{ env.READ_NUM }}
        WXPUSHER_TOPIC_ID: ${{ secrets.WXPUSHER_TOPIC_ID }}
        WXPUSHER_UIDS: ${{ secrets.WXPUSHER_UIDS }}
      run: |
        echo "âœ… å¯åŠ¨è‡ªåŠ¨åŒ–è„šæœ¬ | è®¡åˆ’æ¬¡æ•°: $READ_NUM"
        python -u main.py

    # ========================
    # é˜¶æ®µ4ï¼šæ™ºèƒ½é€šçŸ¥ç³»ç»Ÿ
    # ========================
    - name: ğŸ“¢ å¼‚å¸¸ç›‘æ§
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const status = process.env.STATUS || 'UNKNOWN'
          const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          const message = `âŒ ä»»åŠ¡å¼‚å¸¸ç»ˆæ­¢&#92;nâ–¸ çŠ¶æ€: ${status}&#92;nâ–¸ æ—¥å¿—: ${runUrl}`
          
          // ä¼ä¸šå¾®ä¿¡æœºå™¨äººå¤‡ç”¨é€šçŸ¥
          await fetch('https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              msgtype: "text",
              text: { content: message }
            })
          })
