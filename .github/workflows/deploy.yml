name: WeRead Automation

on:
  schedule:
    - cron: '0 21 * * 1-6'  # åŒ—äº¬æ—¶é—´5:00
    - cron: '40 3 * * 1-6'  # åŒ—äº¬æ—¶é—´11:40
    - cron: '0 14 * * 1-6'  # åŒ—äº¬æ—¶é—´22:00
    - cron: '0 16 * * 6'    # åŒ—äº¬æ—¶é—´å‘¨æ—¥0:00

  workflow_dispatch:
    inputs:
      duration:
        description: 'é˜…è¯»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'
        required: false
        default: '30'

jobs:
  automate_reading:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    environment: Production

    steps:
    - name: ğŸ”§ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y &#92;
          chromium-browser &#92;
          chromium-chromedriver &#92;
          xvfb &#92;
          libgbm-dev

    - name: ğŸ é…ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ å®‰è£…PythonåŒ…
      run: |
        pip install selenium==4.15.2 webdriver-manager==4.0.1

    - name: ğŸª é…ç½®Cookie
      env:
        WEREAD_COOKIE: ${{ secrets.WEREAD_COOKIE }}
      run: |
        mkdir -p /tmp/chrome_profile
        echo '$WEREAD_COOKIE' > /tmp/cookies.json
        jq empty /tmp/cookies.json  # éªŒè¯JSONæ ¼å¼

    - name: â²ï¸ è®¾ç½®é˜…è¯»æ—¶é•¿
      run: |
        case "${{ github.event.schedule }}" in
          *'0 21'*) DURATION=$((40 + RANDOM % 20)) ;;  # æ—©é—´40-60åˆ†é’Ÿ
          *'40 3'*) DURATION=$((60 + RANDOM % 30)) ;;  # åˆé—´60-90åˆ†é’Ÿ
          *'0 14'*) DURATION=$((50 + RANDOM % 25)) ;;  # æ™šé—´50-75åˆ†é’Ÿ
          *) DURATION=${{ inputs.duration || 120 }} ;; # é»˜è®¤120åˆ†é’Ÿ
        esac
        echo "READ_DURATION=$DURATION" >> $GITHUB_ENV

    - name: ğŸ“– æ‰§è¡Œé˜…è¯»ä»»åŠ¡
      env:
        DISPLAY: ':0'
        READ_DURATION: ${{ env.READ_DURATION }}
      run: |
        xvfb-run --auto-servernum &#92;
          python wechat_auto_read.py

    - name: ğŸ“¤ ä¸Šä¼ è°ƒè¯•ä¿¡æ¯
      if: ${{ failure() }}
      uses: actions/upload-artifact@v4
      with:
        name: debug-info-${{ github.run_id }}
        path: |
          automation.log
          /tmp/*.png
        retention-days: 2
