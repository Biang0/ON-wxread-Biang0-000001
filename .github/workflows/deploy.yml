name: Test number

on:
  schedule:
    - cron: '0 14 * * *'       # ÊØèÂ§©Âåó‰∫¨Êó∂Èó¥ 22:00ÔºàUTC 14:00Ôºâ
    - cron: '0 21 * * 0-4'     # Âë®‰∏ÄÂà∞Âë®‰∫îÂåó‰∫¨Êó∂Èó¥ 05:00ÔºàUTC Ââç‰∏ÄÂ§© 21:00Ôºâ
    - cron: '40 3 * * 1-5'     # Âë®‰∏ÄÂà∞Âë®‰∫îÂåó‰∫¨Êó∂Èó¥ 11:40ÔºàUTC 03:40Ôºâ
    - cron: '0 9 * * sat,sun'  # Âë®ÂÖ≠„ÄÅÂë®Êó•Âåó‰∫¨Êó∂Èó¥ 17:00ÔºàUTC 09:00Ôºâ
    - cron: '0 0 * * sat,sun'  # Âë®Êú´Âåó‰∫¨Êó∂Èó¥ 08:00ÔºàUTC Ââç‰∏ÄÂ§© 00:00Ôºâ
  workflow_dispatch:
    description: ÊâãÂä®Ëß¶ÂèëÂæÆ‰ø°ÈòÖËØª‰ªªÂä°
    inputs:
      mode:
        type: choice
        description: |
          ÈÄâÊã©ËøêË°åÊ®°ÂºèÔºö
          - Ëá™Âä®ÔºöËá™Âä®Ê®°ÂºèÔºåÊ†πÊçÆ‰∏çÂêåÁöÑÂÆöÊó∂‰ªªÂä°ËßÑÂàôÔºåÁîüÊàêÁõ∏Â∫îËåÉÂõ¥ÂÜÖÁöÑÈöèÊú∫ÈòÖËØªÊó∂Èó¥„ÄÇÂ¶ÇÊûúÊòØÊâãÂä®Ëß¶Âèë‰∏îÊú™ËÆæÁΩÆËá™ÂÆö‰πâÂª∂ËøüÔºå‰ºöÊúâ 0 - 20 ÂàÜÈíüÁöÑÈöèÊú∫Âª∂Ëøü„ÄÇ
          - ÊâãÂä®ÔºöÊâãÂä®Ê®°ÂºèÔºåËã•Êú™ËæìÂÖ•Ëá™ÂÆö‰πâÈòÖËØªÊó∂Èó¥Ôºå‰ºöÁîüÊàê 60 - 120ÔºàÁ≠âÊïà 30 - 60 ÂàÜÈíüÔºâ‰πãÈó¥ÁöÑÈöèÊú∫ÈòÖËØªÊó∂Èó¥ÔºõËã•ËæìÂÖ•‰∫ÜËá™ÂÆö‰πâÈòÖËØªÊó∂Èó¥ÔºåÂàô‰ΩøÁî®ËØ•Êó∂Èó¥ËÆ°ÁÆóÈòÖËØªÊ¨°Êï∞„ÄÇ
        required: true
        default: 'ÊâãÂä®'
        options:
          - Ëá™Âä®
          - ÊâãÂä®
      custom_time:
        type: string
        description: 'ÊâãÂä®ËæìÂÖ•Ëá™ÂÆö‰πâÈòÖËØªÊó∂Èó¥ÔºàÂàÜÈíüÔºå‰ªÖÊâãÂä®Ëß¶ÂèëÊúâÊïàÔºâ„ÄÇËæìÂÖ•ÂêéÔºå‰ºöÂ∞ÜËØ•Êó∂Èó¥‰πò‰ª• 2 ‰Ωú‰∏∫ READ_NUM Áî®‰∫éÂêéÁª≠‰ªªÂä°„ÄÇ'
        required: false
      custom_delay:
        type: string
        description: 'ÊâãÂä®ËæìÂÖ•Ëá™ÂÆö‰πâÂª∂ËøüÊó∂Èó¥ÔºàÂàÜÈíüÔºå‰ªÖÊâãÂä®Ëß¶ÂèëÊúâÊïàÔºâ„ÄÇËæìÂÖ•ÂêéÔºå‰ªªÂä°‰ºöÂª∂ËøüÁõ∏Â∫îÁöÑÂàÜÈíüÊï∞ÊâßË°å„ÄÇ'
        required: false
      debug_schedule:
        type: choice
        description: 'ÈÄâÊã©Ë∞ÉËØïÂÆöÊó∂‰ªªÂä°ÔºåÂºÄÂêØÂêéÊåâÊåáÂÆö‰ªªÂä°Êó∂Èó¥ËøêË°å'
        required: false
        default: 'Êó†'
        options:
          - Êó†
          - ÊôöÈó¥‰ªªÂä°
          - Êó©Èó¥‰ªªÂä°
          - ÂçàÈó¥‰ªªÂä°
          - Âë®Êú´‰ªªÂä°
          - Âë®ÈöèÊú∫‰ªªÂä°

jobs:
  deploy:
    runs-on: ubuntu-22.04

    steps:
    - name: üîß ËÆæÁΩÆ DNS
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
        echo "‚úÖ DNS ÈÖçÁΩÆÂÆåÊàê"

    - name: üì• Ê£ÄÂá∫‰ªìÂ∫ì
      uses: actions/checkout@v4
      with:
        # Ë¶ÅËÉΩÊé®ÈÄÅÂõû‰ªìÂ∫ìÔºåÈúÄË¶Å fetch-depth=0
        fetch-depth: 0

    - name: üêç ËÆæÁΩÆ Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: üì¶ ÂÆâË£Ö‰æùËµñ
      run: |
        echo "::group::üì¶ ÂÆâË£Ö‰æùËµñ"
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        pip list
        echo "::endgroup::"
        echo "‚úÖ ‰æùËµñÂÆâË£ÖÈ™åËØÅÔºö$(pip list | grep requests)"

    - name: ‚è±Ô∏è ÈöèÊú∫Âª∂ËøüÔºàËá™Âä®Ê®°ÂºèÊàñËÆ°ÂàíÊ®°ÂºèÊàñÊâãÂä®Ëß¶ÂèëË∞ÉËØïÊ®°ÂºèÊó†Ëá™ÂÆö‰πâÂª∂ËøüÔºâ
      if: (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.mode == 'Ëá™Âä®' || github.event.inputs.debug_schedule != 'Êó†') && github.event.inputs.custom_delay == ''))
      run: |
        DELAY_MINUTES=$((RANDOM % 21))
        DELAY_SECONDS=$((RANDOM % 60))
        TOTAL_DELAY=$((DELAY_MINUTES * 60 + DELAY_SECONDS))
        echo "‚è≥ ÁîüÊàêÁöÑÈöèÊú∫Âª∂ËøüÔºö${DELAY_MINUTES} ÂàÜÈíü ${DELAY_SECONDS} Áßí"
        sleep $TOTAL_DELAY
        echo "‚úÖ Âª∂ËøüÊâßË°åÂÆåÊàê"

    - name: ‚è±Ô∏è Ëá™ÂÆö‰πâÂª∂ËøüÔºàÊâãÂä®Ëß¶ÂèëÔºâ
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.custom_delay != ''
      run: |
        DELAY=${{ github.event.inputs.custom_delay }}
        echo "‚è≥ Ëá™ÂÆö‰πâÂª∂ËøüÔºö${DELAY} ÂàÜÈíü"
        sleep $((DELAY * 60))
        echo "‚úÖ Âª∂ËøüÊâßË°åÂÆåÊàê"

    - name: üé≤ Âë®ÈöèÊú∫Ê£ÄÊü•
      id: week_random_check
      if: (github.event_name == 'schedule' && github.event.schedule == '0 0 * * sat,sun') || (github.event_name == 'workflow_dispatch' && github.event.inputs.debug_schedule == 'Âë®ÈöèÊú∫‰ªªÂä°')
      run: |
        CHECK=$((RANDOM % 7))
        echo "üé≤ ÈöèÊú∫Êï∞Ôºö$CHECK (ÈúÄË¶ÅÁ≠â‰∫é0)"
        if [ $CHECK -ne 0 ]; then
          echo "‚è≠Ô∏è Ë∑≥ËøáÂë®ÈöèÊú∫‰ªªÂä°"
          echo "skipped=true" >> $GITHUB_OUTPUT
          exit 0
        else
          echo "üéâ Ëß¶ÂèëÂë®ÈöèÊú∫‰ªªÂä°"
          echo "skipped=false" >> $GITHUB_OUTPUT
        fi

    - name: üî¢ ÁîüÊàê READ_NUM
      if: steps.week_random_check.outputs.skipped != 'true'
      run: |
        echo "::group::üî¢ ÁîüÊàê READ_NUM"
        echo "‰∫ã‰ª∂Á±ªÂûã: ${{ github.event_name }}"
        echo "ËæìÂÖ•Ê®°Âºè: ${{ github.event.inputs.mode }}"
        echo "ÂÆöÊó∂ËßÑÂàô: ${{ github.event.schedule }}"
        echo "Ëá™ÂÆö‰πâÊó∂Èó¥: ${{ github.event.inputs.custom_time }}"
        echo "Ëá™ÂÆö‰πâÂª∂Ëøü: ${{ github.event.inputs.custom_delay }}"
        echo "Ë∞ÉËØïÂÆöÊó∂‰ªªÂä°: ${{ github.event.inputs.debug_schedule }}"

        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ "${{ github.event.inputs.debug_schedule }}" != "Êó†" ]]; then
            case "${{ github.event.inputs.debug_schedule }}" in
              ÊôöÈó¥‰ªªÂä°)
                SCHEDULE='0 14 * * *'
                ;;
              Êó©Èó¥‰ªªÂä°)
                SCHEDULE='0 21 * * 0-4'
                ;;
              ÂçàÈó¥‰ªªÂä°)
                SCHEDULE='40 3 * * 1-5'
                ;;
              Âë®Êú´‰ªªÂä°)
                SCHEDULE='0 9 * * sat,sun'
                ;;
              Âë®ÈöèÊú∫‰ªªÂä°)
                SCHEDULE='0 0 * * sat,sun'
                ;;
            esac
          else
            SCHEDULE="${{ github.event.schedule }}"
          fi

          if [[ -n "${{ github.event.inputs.custom_time }}" ]]; then
            NUM=$(( ${{ github.event.inputs.custom_time }} * 2 ))
            echo "üïπÔ∏è ÊâãÂä®Ëß¶Âèë | ‰ΩøÁî®Ëá™ÂÆö‰πâÊó∂Èó¥: ${{ github.event.inputs.custom_time }} ÂàÜÈíüÔºåÁ≠âÊïà READ_NUM: $NUM"
          else
            if [[ "${{ github.event.inputs.mode }}" == "ÊâãÂä®" ]]; then
              NUM=$((RANDOM % 61 + 60))
              echo "üïπÔ∏è ÊâãÂä®Ê®°Âºè | ËåÉÂõ¥: 60-120 (30-60ÂàÜÈíü)"
            else
              case "$SCHEDULE" in
                '0 21 * * 0-4')
                  NUM=$((RANDOM % 31 + 130))
                  echo "üåÖ Êó©Èó¥‰ªªÂä° | ËåÉÂõ¥: 130-160"
                  ;;
                '40 3 * * 1-5')
                  NUM=$((RANDOM % 31 + 160))
                  echo "üåû ÂçàÈó¥‰ªªÂä° | ËåÉÂõ¥: 160-190"
                  ;;
                '0 14 * * *')
                  NUM=$((RANDOM % 31 + 190))
                  echo "üåô ÊôöÈó¥‰ªªÂä° | ËåÉÂõ¥: 190-220"
                  ;;
                '0 9 * * sat,sun')
                  NUM=$((RANDOM % 31 + 190))
                  echo "üéâ Âë®Êú´‰ªªÂä° | ËåÉÂõ¥: 190-220"
                  ;;
                '0 0 * * sat,sun')
                  NUM=$((RANDOM % 61 + 120))
                  echo "üé∞ Âë®ÈöèÊú∫‰ªªÂä° | ËåÉÂõ¥: 120-180"
                  ;;
                *)
                  NUM=$((RANDOM % 31 + 190))
                  echo "‚ö†Ô∏è Êú™Áü•Ëß¶ÂèëÁ±ªÂûã | ÂêØÁî®ÂÆâÂÖ®ÈªòËÆ§ÂÄº: 190-220"
                  ;;
              esac
            fi
          fi
        else
          SCHEDULE="${{ github.event.schedule }}"
          case "$SCHEDULE" in
            '0 21 * * 0-4')
              NUM=$((RANDOM % 31 + 130))
              echo "üåÖ Êó©Èó¥‰ªªÂä° | ËåÉÂõ¥: 130-160"
              ;;
            '40 3 * * 1-5')
              NUM=$((RANDOM % 31 + 160))
              echo "üåû ÂçàÈó¥‰ªªÂä° | ËåÉÂõ¥: 160-190"
              ;;
            '0 14 * * *')
              NUM=$((RANDOM % 31 + 190))
              echo "üåô ÊôöÈó¥‰ªªÂä° | ËåÉÂõ¥: 190-220"
              ;;
            '0 9 * * sat,sun')
              NUM=$((RANDOM % 31 + 190))
              echo "üéâ Âë®Êú´‰ªªÂä° | ËåÉÂõ¥: 190-220"
              ;;
            '0 0 * * sat,sun')
              NUM=$((RANDOM % 61 + 120))
              echo "üé∞ Âë®ÈöèÊú∫‰ªªÂä° | ËåÉÂõ¥: 120-180"
              ;;
            *)
              NUM=$((RANDOM % 31 + 190))
              echo "‚ö†Ô∏è Êú™Áü•Ëß¶ÂèëÁ±ªÂûã | ÂêØÁî®ÂÆâÂÖ®ÈªòËÆ§ÂÄº: 190-220"
              ;;
          esac
        fi

        echo "‚úÖ ÊúÄÁªà READ_NUM: $NUM (Á≠âÊïà $((NUM / 2)) ÂàÜÈíü)"
        echo "READ_NUM=$NUM" >> $GITHUB_ENV
        echo "::endgroup::"

     - name: üöÄ ÊâßË°å‰∏ªÁ®ãÂ∫è
      if: steps.week_random_check.outputs.skipped != 'true'
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
        PUSH_METHOD: ${{ secrets.PUSH_METHOD }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        WXPUSHER_SPT: ${{ secrets.WXPUSHER_SPT }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        READ_NUM: ${{ env.READ_NUM }}
        READ_COMPLETE_HEADER: ${{ secrets.READ_COMPLETE_HEADER }}
      run: |
        echo "=== ÊâßË°åÂèÇÊï∞ ==="
        echo "READ_NUM: ${{ env.READ_NUM }}"
        echo "READ_COMPLETE_HEADER: ${{ env.READ_COMPLETE_HEADER }}"
        python main.py || { echo "‚ùå ‰∏ªÁ®ãÂ∫èÊâßË°åÂ§±Ë¥•"; exit 1; }

 - name: üì§ Êèê‰∫§Âπ∂Êé®ÈÄÅ run_data.log
      if: always()
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        git add run_data.log
        git commit -m "Update run_data.log [skip ci]" || echo "No changes to commit"
        git push