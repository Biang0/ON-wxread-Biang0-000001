name: wxread

# å®šä¹‰å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶ä»»åŠ¡è§¦å‘æ¡ä»¶
  schedule:
    - cron: '0 14 * * *'          # æ™šé—´ä»»åŠ¡ï¼šæ¯å¤©22:00è§¦å‘
    - cron: '0 21 * * 1-5'        # æ—©é—´ä»»åŠ¡ï¼šå‘¨ä¸€åˆ°å‘¨äº”05:00è§¦å‘
    - cron: '40 3 * * 1-5'        # åˆé—´ä»»åŠ¡ï¼šå‘¨ä¸€åˆ°å‘¨äº”11:40è§¦å‘
    - cron: '0 9 * * sat,sun'     # å‘¨æœ«ä»»åŠ¡ï¼šå‘¨å…­å’Œå‘¨æ—¥17:00è§¦å‘
    - cron: '0 0 * * sat,sun'     # å‘¨éšæœºä»»åŠ¡ï¼šå‘¨æœ«08:00è§¦å‘
  # æ‰‹åŠ¨è§¦å‘æ¡ä»¶
  workflow_dispatch:
    description: æ‰‹åŠ¨è§¦å‘å¾®ä¿¡é˜…è¯»ä»»åŠ¡
    inputs:
      mode:
        type: choice
        description: |
          é€‰æ‹©è¿è¡Œæ¨¡å¼ï¼š
          - autoï¼šè‡ªåŠ¨æ¨¡å¼ï¼Œæ ¹æ®ä¸åŒçš„å®šæ—¶ä»»åŠ¡è§„åˆ™ï¼Œç”Ÿæˆç›¸åº”èŒƒå›´å†…çš„éšæœºé˜…è¯»æ—¶é—´ã€‚å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æœªè®¾ç½®è‡ªå®šä¹‰å»¶è¿Ÿï¼Œä¼šæœ‰ 0 - 20 åˆ†é’Ÿçš„éšæœºå»¶è¿Ÿã€‚
          - manualï¼šæ‰‹åŠ¨æ¨¡å¼ï¼Œè‹¥æœªè¾“å…¥è‡ªå®šä¹‰é˜…è¯»æ—¶é—´ï¼Œä¼šç”Ÿæˆ 60 - 120ï¼ˆç­‰æ•ˆ 30 - 60 åˆ†é’Ÿï¼‰ä¹‹é—´çš„éšæœºé˜…è¯»æ—¶é—´ï¼›è‹¥è¾“å…¥äº†è‡ªå®šä¹‰é˜…è¯»æ—¶é—´ï¼Œåˆ™ä½¿ç”¨è¯¥æ—¶é—´è®¡ç®—é˜…è¯»æ¬¡æ•°ã€‚
        required: true
        default: 'manual'
        options:
          - auto
          - manual
      custom_time:
        type: string
        description: 'æ‰‹åŠ¨è¾“å…¥è‡ªå®šä¹‰é˜…è¯»æ—¶é—´ï¼ˆåˆ†é’Ÿï¼Œä»…æ‰‹åŠ¨è§¦å‘æœ‰æ•ˆï¼‰ã€‚è¾“å…¥åï¼Œä¼šå°†è¯¥æ—¶é—´ä¹˜ä»¥ 2 ä½œä¸º READ_NUM ç”¨äºåç»­ä»»åŠ¡ã€‚'
        required: false
      custom_delay:
        type: string
        description: 'æ‰‹åŠ¨è¾“å…¥è‡ªå®šä¹‰å»¶è¿Ÿæ—¶é—´ï¼ˆåˆ†é’Ÿï¼Œä»…æ‰‹åŠ¨è§¦å‘æœ‰æ•ˆï¼‰ã€‚è¾“å…¥åï¼Œä»»åŠ¡ä¼šå»¶è¿Ÿç›¸åº”çš„åˆ†é’Ÿæ•°æ‰§è¡Œã€‚'
        required: false

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    - name: ğŸ”§ è®¾ç½® DNS
      run: |
        # é…ç½®ä¸» DNS æœåŠ¡å™¨ä¸º Google çš„å…¬å…± DNS
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        # é…ç½®å¤‡ç”¨ DNS æœåŠ¡å™¨ä¸º Google çš„å…¬å…± DNS
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
        echo "âœ… DNS é…ç½®å®Œæˆ"

    - name: ğŸ“¥ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½® Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        # å‡çº§ pip åˆ°æœ€æ–°ç‰ˆæœ¬
        python -m pip install --upgrade pip
        # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ä¾èµ–åº“
        pip install certifi==2024.8.30 charset-normalizer==3.4.0 idna==3.10.0 requests==2.32.3 urllib3==2.2.3
        # éªŒè¯ requests åº“æ˜¯å¦å®‰è£…æˆåŠŸ
        echo "âœ… ä¾èµ–å®‰è£…éªŒè¯ï¼š$(pip list | grep requests)"

    - name: â±ï¸ éšæœºå»¶è¿Ÿï¼ˆè‡ªåŠ¨æ¨¡å¼æˆ–è®¡åˆ’æ¨¡å¼æˆ–æ‰‹åŠ¨è§¦å‘ auto æ— è‡ªå®šä¹‰å»¶è¿Ÿï¼‰
      if: (github.event.inputs.mode == 'auto' && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.custom_delay == '')))
      run: |
        # ç”Ÿæˆ 0 åˆ° 20 ä¹‹é—´çš„éšæœºæ•°ä½œä¸ºå»¶è¿Ÿåˆ†é’Ÿæ•°
        DELAY=$((RANDOM % 21))
        echo "â³ ç”Ÿæˆçš„éšæœºå»¶è¿Ÿï¼š${DELAY} åˆ†é’Ÿ"
        TOTAL_SECONDS=$((DELAY * 60))
        echo "::group::å»¶è¿Ÿå€’è®¡æ—¶"
        for ((i = 0; i <= TOTAL_SECONDS; i++)); do
          REMAINING=$((TOTAL_SECONDS - i))
          MINUTES=$((REMAINING / 60))
          SECONDS=$((REMAINING % 60))
          printf "\rå‰©ä½™æ—¶é—´: %02d:%02d" "$MINUTES" "$SECONDS"
          sleep 1
        done
        echo -e "\n::endgroup::"
        echo "âœ… å»¶è¿Ÿæ‰§è¡Œå®Œæˆ"

    - name: â±ï¸ è‡ªå®šä¹‰å»¶è¿Ÿï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.custom_delay != ''
      run: |
        DELAY=${{ github.event.inputs.custom_delay }}
        echo "â³ è‡ªå®šä¹‰å»¶è¿Ÿï¼š${DELAY} åˆ†é’Ÿ"
        TOTAL_SECONDS=$((DELAY * 60))
        echo "::group::å»¶è¿Ÿå€’è®¡æ—¶"
        for ((i = 0; i <= TOTAL_SECONDS; i++)); do
          REMAINING=$((TOTAL_SECONDS - i))
          MINUTES=$((REMAINING / 60))
          SECONDS=$((REMAINING % 60))
          printf "\rå‰©ä½™æ—¶é—´: %02d:%02d" "$MINUTES" "$SECONDS"
          sleep 1
        done
        echo -e "\n::endgroup::"
        echo "âœ… å»¶è¿Ÿæ‰§è¡Œå®Œæˆ"

    - name: ğŸ² å‘¨éšæœºæ£€æŸ¥
      if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * sat,sun'
      run: |
        # ç”Ÿæˆ 0 åˆ° 6 ä¹‹é—´çš„éšæœºæ•°
        CHECK=$((RANDOM % 7))
        echo "ğŸ² éšæœºæ•°ï¼š$CHECK (éœ€è¦ç­‰äº0)"
        # å¦‚æœéšæœºæ•°ä¸ç­‰äº 0ï¼Œåˆ™è·³è¿‡å‘¨éšæœºä»»åŠ¡
        if [ $CHECK -ne 0 ]; then
          echo "â­ï¸ è·³è¿‡å‘¨éšæœºä»»åŠ¡"
          exit 0
        fi
        echo "ğŸ‰ è§¦å‘å‘¨éšæœºä»»åŠ¡"

    - name: ğŸ”¢ ç”Ÿæˆ READ_NUM
      run: |
        echo "=== è§¦å‘äº‹ä»¶åˆ†æ ==="
        echo "äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
        echo "è¾“å…¥æ¨¡å¼: ${{ github.event.inputs.mode }}"
        echo "å®šæ—¶è§„åˆ™: ${{ github.event.schedule }}"
        echo "è‡ªå®šä¹‰æ—¶é—´: ${{ github.event.inputs.custom_time }}"
        echo "è‡ªå®šä¹‰å»¶è¿Ÿ: ${{ github.event.inputs.custom_delay }}"

        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ—¶é—´ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [[ -n "${{ github.event.inputs.custom_time }}" ]]; then
            # è‹¥ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥äº†è‡ªå®šä¹‰é˜…è¯»æ—¶é—´ï¼Œåˆ™å°†å…¶ä¹˜ä»¥ 2 ä½œä¸º READ_NUM
            NUM=$(( ${{ github.event.inputs.custom_time }} * 2 ))
            echo "ğŸ•¹ï¸ æ‰‹åŠ¨è§¦å‘ | ä½¿ç”¨è‡ªå®šä¹‰æ—¶é—´: ${{ github.event.inputs.custom_time }} åˆ†é’Ÿï¼Œç­‰æ•ˆ READ_NUM: $NUM"
          else
            # æ‰‹åŠ¨è§¦å‘ä½†æœªæä¾›è‡ªå®šä¹‰æ—¶é—´æ—¶ï¼Œæ ¹æ® mode ç”Ÿæˆé»˜è®¤å€¼
            if [[ "${{ github.event.inputs.mode }}" == "manual" ]]; then
              # æ‰‹åŠ¨æ¨¡å¼ä¸‹ï¼Œç”Ÿæˆ 60 åˆ° 120 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              # è¯¥èŒƒå›´ç­‰æ•ˆäº 30 åˆ° 60 åˆ†é’Ÿçš„é˜…è¯»æ—¶é—´
              NUM=$((RANDOM % 61 + 60))
              echo "ğŸ•¹ï¸ æ‰‹åŠ¨æ¨¡å¼ | èŒƒå›´: 60-120 (30-60åˆ†é’Ÿ)"
            else
              # æ‰‹åŠ¨è§¦å‘ auto æ¨¡å¼æ—¶ï¼Œä½¿ç”¨é»˜è®¤çš„ auto èŒƒå›´
              SCHEDULE="${{ github.event.schedule }}"
              case "$SCHEDULE" in
                '0 21 * * 1-5')
                  # æ—©é—´ä»»åŠ¡ï¼ˆå‘¨ä¸€åˆ°å‘¨äº” 05:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 130 åˆ° 160 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 31 + 130))
                  echo "ğŸŒ… æ—©é—´ä»»åŠ¡ | èŒƒå›´: 130-160"
                  ;;
                '40 3 * * 1-5')
                  # åˆé—´ä»»åŠ¡ï¼ˆå‘¨ä¸€åˆ°å‘¨äº” 11:40 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 160 åˆ° 190 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 31 + 160))
                  echo "ğŸŒ åˆé—´ä»»åŠ¡ | èŒƒå›´: 160-190"
                  ;;
                '0 14 * * *')
                  # æ™šé—´ä»»åŠ¡ï¼ˆæ¯å¤© 22:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 31 + 190))
                  echo "ğŸŒ™ æ™šé—´ä»»åŠ¡ | èŒƒå›´: 190-220"
                  ;;
                '0 9 * * sat,sun')
                  # å‘¨æœ«ä»»åŠ¡ï¼ˆå‘¨å…­å’Œå‘¨æ—¥ 17:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 31 + 190))
                  echo "ğŸ‰ å‘¨æœ«ä»»åŠ¡ | èŒƒå›´: 190-220"
                  ;;
                '0 0 * * sat,sun')
                  # å‘¨éšæœºä»»åŠ¡ï¼ˆå‘¨æœ« 08:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 120 åˆ° 180 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 61 + 120))
                  echo "ğŸ° å‘¨éšæœºä»»åŠ¡ | èŒƒå›´: 120-180"
                  ;;
                *)
                  # æœªçŸ¥è§¦å‘ç±»å‹ï¼Œå¯ç”¨å®‰å…¨é»˜è®¤å€¼ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
                  NUM=$((RANDOM % 31 + 190))
                  echo "âš ï¸ æœªçŸ¥è§¦å‘ç±»å‹ | å¯ç”¨å®‰å…¨é»˜è®¤å€¼: 190-220"
                  ;;
              esac
            fi
          fi
        else
          # è‡ªåŠ¨è§¦å‘ï¼ˆscheduleï¼‰æ—¶ï¼ŒæŒ‰åŸé€»è¾‘ç”Ÿæˆ
          SCHEDULE="${{ github.event.schedule }}"
          case "$SCHEDULE" in
            '0 21 * * 1-5')
              # æ—©é—´ä»»åŠ¡ï¼ˆå‘¨ä¸€åˆ°å‘¨äº” 05:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 130 åˆ° 160 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 31 + 130))
              echo "ğŸŒ… æ—©é—´ä»»åŠ¡ | èŒƒå›´: 130-160"
              ;;
            '40 3 * * 1-5')
              # åˆé—´ä»»åŠ¡ï¼ˆå‘¨ä¸€åˆ°å‘¨äº” 11:40 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 160 åˆ° 190 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 31 + 160))
              echo "ğŸŒ åˆé—´ä»»åŠ¡ | èŒƒå›´: 160-190"
              ;;
            '0 14 * * *')
              # æ™šé—´ä»»åŠ¡ï¼ˆæ¯å¤© 22:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 31 + 190))
              echo "ğŸŒ™ æ™šé—´ä»»åŠ¡ | èŒƒå›´: 190-220"
              ;;
            '0 9 * * sat,sun')
              # å‘¨æœ«ä»»åŠ¡ï¼ˆå‘¨å…­å’Œå‘¨æ—¥ 17:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 31 + 190))
              echo "ğŸ‰ å‘¨æœ«ä»»åŠ¡ | èŒƒå›´: 190-220"
              ;;
            '0 0 * * sat,sun')
              # å‘¨éšæœºä»»åŠ¡ï¼ˆå‘¨æœ« 08:00 è§¦å‘ï¼‰ï¼Œç”Ÿæˆ 120 åˆ° 180 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 61 + 120))
              echo "ğŸ° å‘¨éšæœºä»»åŠ¡ | èŒƒå›´: 120-180"
              ;;
            *)
              # æœªçŸ¥è§¦å‘ç±»å‹ï¼Œå¯ç”¨å®‰å…¨é»˜è®¤å€¼ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ä½œä¸º READ_NUM
              NUM=$((RANDOM % 31 + 190))
              echo "âš ï¸ æœªçŸ¥è§¦å‘ç±»å‹ | å¯ç”¨å®‰å…¨é»˜è®¤å€¼: 190-220"
              ;;
          esac
        fi

        echo "âœ… æœ€ç»ˆ READ_NUM: $NUM (ç­‰æ•ˆ $((NUM / 2)) åˆ†é’Ÿ)"
        # å°† READ_NUM å†™å…¥ç¯å¢ƒå˜é‡
        echo "READ_NUM=$NUM" >> $GITHUB_ENV

    - name: ğŸš€ æ‰§è¡Œä¸»ç¨‹åº
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
      run: |
        echo "=== æ‰§è¡Œå‚æ•° ==="
        echo "READ_NUM: ${{ env.READ_NUM }}"
        # æ‰§è¡Œä¸»ç¨‹åº
        python main.py    
