name: wxread

on:
  schedule:
    # UTCæ—¶é—´ä¸åŒ—äº¬æ—¶é—´å¯¹åº”å…³ç³»ï¼š
    # æ—©é—´ä»»åŠ¡ï¼šUTC 21:00 â†’ åŒ—äº¬ 05:00ï¼ˆæ¬¡æ—¥ï¼‰
    - cron: '0 21 * * *'    # åŒ—äº¬ 05:00
    
    # åˆé—´ä»»åŠ¡ï¼šUTC 03:40 â†’ åŒ—äº¬ 11:40
    - cron: '40 3 * * *'    # åŒ—äº¬ 11:40
    
    # æ™šé—´ä»»åŠ¡ï¼šUTC 14:00 â†’ åŒ—äº¬ 22:00
    - cron: '0 14 * * *'    # åŒ—äº¬ 22:00
    
    # å‘¨æ—¥å…¨å¤©ä»»åŠ¡ï¼šUTC 16-23ï¼ˆå‘¨å…­ï¼‰ + 0-15ï¼ˆå‘¨æ—¥ï¼‰ â†’ åŒ—äº¬ 00:00-23:59ï¼ˆå‘¨æ—¥ï¼‰
    - cron: '0 16-23,0-15 * * 6'  # åŒ—äº¬å‘¨æ—¥å…¨å¤©è¦†ç›–

  workflow_dispatch:
    inputs:
      duration:
        description: 'æ‰‹åŠ¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰45-90'
        required: false
        type: number

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai  # å®¹å™¨å†…æ˜¾ç¤ºåŒ—äº¬æ—¶é—´

    steps:
    - name: â° æ—¶é—´ç­–ç•¥å¼•æ“
      id: time_engine
      run: |
        # è·å–å½“å‰UTCæ˜ŸæœŸå‡ ï¼ˆ0=å‘¨æ—¥ï¼‰
        DAY=$(date -u +%w)
        HOUR=$(date -u +%H)
        
        # å‘¨æ—¥ä»»åŠ¡é€»è¾‘ï¼ˆåŒ—äº¬æ—¶é—´å‘¨æ—¥å…¨å¤©ï¼‰
        if [[ "${{ github.event.schedule }}" == '0 16-23,0-15 * * 6' ]]; then
          # æ¯å¤©éšæœºæ‰§è¡Œä¸€æ¬¡
          if (( RANDOM % 1440 < 60 )); then  # æ¯å°æ—¶æœ‰1/24æ¦‚ç‡æ‰§è¡Œ
            READ_NUM=$(( 90 + RANDOM % 91 ))  # 45-90åˆ†é’Ÿ
            echo "ğŸ² å‘¨æ—¥éšæœºä»»åŠ¡è§¦å‘"
          else
            echo "â­ï¸ å‘¨æ—¥æœªå‘½ä¸­éšæœºæ—¶æ®µ"
            exit 0
          fi
        else
          # åŸæœ‰å‘¨ä¸€åˆ°å‘¨å…­é€»è¾‘ä¿æŒ...
        fi

        # æ·»åŠ å»¶è¿Ÿå‚æ•°
        echo "DELAY_MINUTES=$(( RANDOM % 21 ))" >> $GITHUB_ENV
        echo "READ_NUM=$READ_NUM" >> $GITHUB_OUTPUT

    - name: â³ å‘¨æ—¥éšæœºå»¶è¿Ÿ
      if: ${{ contains(github.event.schedule, '0 16-23,0-15 * * 6') }}
      run: |
        echo "â±ï¸ å‘¨æ—¥ä»»åŠ¡éšæœºå»¶è¿Ÿ ${{ env.DELAY_MINUTES }} åˆ†é’Ÿ"
        sleep $(( ${{ env.DELAY_MINUTES }} * 60 ))

    - name: ğŸš€ æ‰§è¡Œæ ¸å¿ƒä»»åŠ¡
      env:
        READ_NUM: ${{ steps.time_engine.outputs.READ_NUM }}
      run: |
        echo "âœ… æœ€ç»ˆå‚æ•° | READ_NUM: $READ_NUM | æ€»è€—æ—¶: $((READ_NUM/2))åˆ†é’Ÿ"
        # python main.py --read_num $READ_NUM
