name: wxread

# å®šä¹‰å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶ä»»åŠ¡è§¦å‘æ¡ä»¶
  schedule:
    - cron: '0 14 * * *'          # æ™šé—´ä»»åŠ¡ï¼šæ¯å¤©22:00è§¦å‘
    - cron: '0 21 * * 1-5'        # æ—©é—´ä»»åŠ¡ï¼šå‘¨ä¸€åˆ°å‘¨äº”05:00è§¦å‘
    - cron: '40 3 * * 1-5'        # åˆé—´ä»»åŠ¡ï¼šå‘¨ä¸€åˆ°å‘¨äº”11:40è§¦å‘
    - cron: '0 9 * * sat,sun'     # å‘¨æœ«ä»»åŠ¡ï¼šå‘¨å…­å’Œå‘¨æ—¥17:00è§¦å‘
    - cron: '0 0 * * sat,sun'     # å‘¨éšæœºä»»åŠ¡ï¼šå‘¨æœ«08:00è§¦å‘
  # æ‰‹åŠ¨è§¦å‘æ¡ä»¶
  workflow_dispatch:
    description: æ‰‹åŠ¨è§¦å‘å¾®ä¿¡é˜…è¯»ä»»åŠ¡ï¼ˆä¸è§¦å‘éšæœºå»¶è¿Ÿï¼‰
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'manual'
      task_type:
        type: choice
        description: 'é€‰æ‹©ä»»åŠ¡ç±»å‹'
        required: false
        default: 'å¸¸è§„ä»»åŠ¡'
        options:
          - å¿«é€Ÿä»»åŠ¡
          - å¸¸è§„ä»»åŠ¡
          - æ·±åº¦ä»»åŠ¡
      debug_mode:
        type: boolean
        description: 'æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼'
        required: false
        default: false

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    - name: ğŸ”§ è®¾ç½® DNS
      run: |
        # é…ç½®ä¸» DNS æœåŠ¡å™¨ä¸º Google çš„å…¬å…± DNS
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        # é…ç½®å¤‡ç”¨ DNS æœåŠ¡å™¨ä¸º Google çš„å…¬å…± DNS
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
        echo "âœ… DNS é…ç½®å®Œæˆ"

    - name: ğŸ“¥ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½® Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        # å‡çº§ pip åˆ°æœ€æ–°ç‰ˆæœ¬
        python -m pip install --upgrade pip
        # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ä¾èµ–åº“
        pip install certifi==2024.8.30 charset-normalizer==3.4.0 idna==3.10.0 requests==2.32.3 urllib3==2.2.3
        # éªŒè¯ requests åº“æ˜¯å¦å®‰è£…æˆåŠŸ
        echo "âœ… ä¾èµ–å®‰è£…éªŒè¯ï¼š$(pip list | grep requests)"

    - name: â±ï¸ éšæœºå»¶è¿Ÿï¼ˆè‡ªåŠ¨æ¨¡å¼æˆ–è®¡åˆ’æ¨¡å¼ï¼‰
      if: github.event.inputs.mode == 'auto' || github.event_name == 'schedule'
      run: |
        # ç”Ÿæˆ 0 åˆ° 20 ä¹‹é—´çš„éšæœºæ•°ä½œä¸ºå»¶è¿Ÿåˆ†é’Ÿæ•°
        DELAY=$((RANDOM % 21))
        echo "â³ ç”Ÿæˆçš„éšæœºå»¶è¿Ÿï¼š${DELAY} åˆ†é’Ÿ"
        # å»¶è¿ŸæŒ‡å®šçš„åˆ†é’Ÿæ•°
        sleep $((DELAY * 60))
        echo "âœ… å»¶è¿Ÿæ‰§è¡Œå®Œæˆ"

    - name: ğŸ² å‘¨éšæœºæ£€æŸ¥
      if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * sat,sun'
      run: |
        # ç”Ÿæˆ 0 åˆ° 6 ä¹‹é—´çš„éšæœºæ•°
        CHECK=$((RANDOM % 7))
        echo "ğŸ² éšæœºæ•°ï¼š$CHECK (éœ€è¦ç­‰äº0)"
        # å¦‚æœéšæœºæ•°ä¸ç­‰äº 0ï¼Œåˆ™è·³è¿‡å‘¨éšæœºä»»åŠ¡
        if [ $CHECK -ne 0 ]; then
          echo "â­ï¸ è·³è¿‡å‘¨éšæœºä»»åŠ¡"
          exit 0
        fi
        echo "ğŸ‰ è§¦å‘å‘¨éšæœºä»»åŠ¡"

    - name: ğŸ”¢ ç”Ÿæˆ READ_NUM
      run: |
        echo "=== è§¦å‘äº‹ä»¶åˆ†æ ==="
        echo "äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
        echo "è¾“å…¥æ¨¡å¼: ${{ github.event.inputs.mode }}"
        echo "å®šæ—¶è§„åˆ™: ${{ github.event.schedule }}"
        echo "ä»»åŠ¡ç±»å‹: ${{ github.event.inputs.task_type }}"
        echo "è°ƒè¯•æ¨¡å¼: ${{ github.event.inputs.debug_mode }}"

        if [[ "${{ github.event.inputs.mode }}" == "manual" ]]; then
          # æ‰‹åŠ¨æ¨¡å¼ä¸‹ï¼Œç”Ÿæˆ 60 åˆ° 120 ä¹‹é—´çš„éšæœºæ•°ï¼ˆç­‰æ•ˆ 30 - 60 åˆ†é’Ÿï¼‰
          NUM=$((RANDOM % 61 + 60))
          echo "ğŸ•¹ï¸ æ‰‹åŠ¨æ¨¡å¼ | èŒƒå›´: 60-120 (30-60åˆ†é’Ÿ)"
        else
          SCHEDULE="${{ github.event.schedule }}"
          case "$SCHEDULE" in
            '0 21 * * 1-5')
              # æ—©é—´ä»»åŠ¡ï¼Œç”Ÿæˆ 130 åˆ° 160 ä¹‹é—´çš„éšæœºæ•°ï¼ˆç­‰æ•ˆ 65 - 80 åˆ†é’Ÿï¼‰
              NUM=$((RANDOM % 31 + 130))
              echo "ğŸŒ… æ—©é—´ä»»åŠ¡ | èŒƒå›´: 130-160"
              ;;
            '40 3 * * 1-5')
              # åˆé—´ä»»åŠ¡ï¼Œç”Ÿæˆ 160 åˆ° 190 ä¹‹é—´çš„éšæœºæ•°ï¼ˆç­‰æ•ˆ 80 - 95 åˆ†é’Ÿï¼‰
              NUM=$((RANDOM % 31 + 160))
              echo "ğŸŒ åˆé—´ä»»åŠ¡ | èŒƒå›´: 160-190"
              ;;
            '0 14 * * *')
              # æ™šé—´ä»»åŠ¡ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ï¼ˆç­‰æ•ˆ 95 - 110 åˆ†é’Ÿï¼‰
              NUM=$((RANDOM % 31 + 190))
              echo "ğŸŒ™ æ™šé—´ä»»åŠ¡ | èŒƒå›´: 190-220"
              ;;
            '0 9 * * sat,sun')
              # å‘¨æœ«ä»»åŠ¡ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°ï¼ˆç­‰æ•ˆ 95 - 110 åˆ†é’Ÿï¼‰
              NUM=$((RANDOM % 31 + 190))
              echo "ğŸ‰ å‘¨æœ«ä»»åŠ¡ | èŒƒå›´: 190-220"
              ;;
            '0 0 * * sat,sun')
              # å‘¨éšæœºä»»åŠ¡ï¼Œç”Ÿæˆ 120 åˆ° 180 ä¹‹é—´çš„éšæœºæ•°ï¼ˆç­‰æ•ˆ 60 - 90 åˆ†é’Ÿï¼‰
              NUM=$((RANDOM % 61 + 120))
              echo "ğŸ° å‘¨éšæœºä»»åŠ¡ | èŒƒå›´: 120-180"
              ;;
            *)
              # æœªçŸ¥è§¦å‘ç±»å‹ï¼Œå¯ç”¨å®‰å…¨é»˜è®¤å€¼ï¼Œç”Ÿæˆ 190 åˆ° 220 ä¹‹é—´çš„éšæœºæ•°
              NUM=$((RANDOM % 31 + 190))
              echo "âš ï¸ æœªçŸ¥è§¦å‘ç±»å‹ | å¯ç”¨å®‰å…¨é»˜è®¤å€¼: 190-220"
              ;;
          esac
        fi

        echo "âœ… æœ€ç»ˆ READ_NUM: $NUM (ç­‰æ•ˆ $((NUM / 2)) åˆ†é’Ÿ)"
        # å°† READ_NUM å†™å…¥ç¯å¢ƒå˜é‡
        echo "READ_NUM=$NUM" >> $GITHUB_ENV

    - name: ğŸš€ æ‰§è¡Œä¸»ç¨‹åº
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
        TASK_TYPE: ${{ github.event.inputs.task_type }}
        DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
      run: |
        echo "=== æ‰§è¡Œå‚æ•° ==="
        echo "READ_NUM: ${{ env.READ_NUM }}"
        echo "ä»»åŠ¡ç±»å‹: ${{ env.TASK_TYPE }}"
        echo "è°ƒè¯•æ¨¡å¼: ${{ env.DEBUG_MODE }}"
        # æ‰§è¡Œä¸»ç¨‹åº
        python main.py 
